var attach=function(e){const t="Request has been aborted",r=e=>e>=200&&e<=204,n=(e,t,r,n)=>{const{status:o,response:s,responseType:i}=e,a=t(o),l=(e=>e.split("\n").reduce(((e,t)=>{const r=t.indexOf(":"),n=t.substr(0,r).trim().toLowerCase(),o=t.substr(r+1).trim();return n&&(e[n]=e[n]?`${e[n]}, ${o}`:o),e}),{}))(e.getAllResponseHeaders());let c;if("blob"===i)c=s;else{const{responseText:t}=e;try{c=JSON.parse(t)}catch(e){c=t}}a?r({status:o,data:c,headers:l}):n({status:o,data:c,message:`Request failed with status code ${o}`,headers:l})},o=(e,t,r)=>{e.send(((e,t)=>["POST","PUT","PATCH"].includes(e)?"object"!=typeof t||t instanceof Blob||t instanceof FormData?t:JSON.stringify(t):null)(t,r))};var s=()=>{let e=null;const s=(s,i,a,{headers:l={},validateStatus:c=r,withCredentials:d=!1,cancelLast:h=!1,onUploadProgress:u,responseType:E="",signal:p})=>(h&&(console.log("You are using deprecated option that will be removed in next major version of opbox-web-browser. Consider using signal option instead"),null!==e&&e.abort()),(e=>{let t=0;return new Promise(((r,n)=>{const o=()=>{t+=1,e().then(r).catch((e=>{if(0===(null==e?void 0:e.status)&&t<5)if(navigator.onLine)setTimeout(o,300*t);else{const e=()=>{window.removeEventListener("online",e),o()};window.addEventListener("online",e)}else n(e)}))};o()}))})((()=>{if(p&&p.aborted)return Promise.reject(new Error(t));const r=((e,t,r,n,o,s)=>{const i=new XMLHttpRequest;return i.open(e,t,!0),Object.keys(r).forEach((e=>{i.setRequestHeader(e,r[e])})),i.withCredentials=n,i.responseType=s,i.upload&&o&&i.upload.addEventListener("progress",o),i})(s,i,l,d,u,E);e=r;const h=((e,t,r)=>new Promise(((o,s)=>{function i(){n(e,t,o,s),c()}function a(){n(e,t,o,s),c()}function l(){e.abort(),s(new Error("Request has been aborted")),c()}function c(){e.removeEventListener("load",i),e.removeEventListener("error",a),r&&r.removeEventListener("abort",l)}e.addEventListener("load",i),e.addEventListener("error",a),r&&r.addEventListener("abort",l)})))(r,c,p).finally((()=>{e=null}));return o(r,s,a),h})));return{request:s,get:(e,t={})=>s("GET",e,{},t),post:(e,t,r)=>s("POST",e,t,r),put:(e,t,r)=>s("PUT",e,t,r),patch:(e,t,r)=>s("PATCH",e,t,r),delete:(e,t={})=>s("DELETE",e,{},t)}};const i="opbox",a=e=>e[i]||{};class l extends Error{constructor(e){super(e),this.message=e,this.name="PageRenderingError"}}const c="metrum-",d="/metrum/",h="data-opbox-fragment-pathname";function u(e){return"object"==typeof e&&!Array.isArray(e)&&null!==e}function E(e){return null===e||"object"!=typeof e||0===Object.keys(e).length}function p(e){return Boolean("object"==typeof HTMLElement?e instanceof HTMLElement:e&&"object"==typeof e&&1===e.nodeType&&"string"==typeof e.nodeName)}function m(e=""){return e.includes(d)}function g(e){return"string"!=typeof e?"":e.split(d)[1].split("/")[0].replace(c,"")}function b(){}function N(e,t,r){let n;return function(...r){return clearTimeout(n),n=setTimeout((()=>{n=null,e.apply(this,r)}),t),n}}function I(e,t,r={}){const n=new CustomEvent(t,Object.assign({bubbles:!1,cancelable:!0},r));e.dispatchEvent(n)}function f(e,t,...r){if(0===r.length)return e=t;const[n,...o]=r;return(e="object"!=typeof e?{}:e)[n]=f(e[n],t,...o),e}function C(e,t){return Object.keys(e).reduce(((r,n)=>{const o=e[n],s="object"==typeof o?C(o,t):o;return r[t.find((e=>n.toLowerCase()===e.toLowerCase()))||n]=s,r}),{})}function A(e,t=()=>!1){Object.keys(e).forEach((r=>{Object.prototype.hasOwnProperty.call(e,r)&&t(r,e[r])&&delete e[r]}))}const S=/Version\/[\d.]+.*Safari/,T=/iPhone|iPad|iPod|Android/i;const v=e=>(t,r)=>Object.assign(Object.assign({},t),e(r)),O=()=>Date.now();function y(e){return"noModule"in e.document.createElement("script")}function P(e){setTimeout(e,0)}function R(e,t){"loading"===e.readyState?e.addEventListener("DOMContentLoaded",t):t()}class x{constructor({data:e,headers:t}){this.data=e,this.headers=t}get valid(){return u(this.data)}}class w{constructor(e={}){this.dataSources=e}resolve(e,t){const{value:r}=e;if("DATA_SOURCE"===e.type){const e=this.dataSources[r];return Object.assign(Object.assign({},e&&e.data&&{[t]:e.data}),e&&!E(e.metadata)&&{[`${t}.$meta`]:e.metadata})}return{[t]:r}}resolveAll(e){return Object.keys(e).reduce(((t,r)=>Object.assign(Object.assign({},t),this.resolve(e[r],r))),{})}}class _{constructor({boxes:e={},dataSources:t={},meta:r={}}={}){this.boxes=e,this.dataSources=t,this.meta=r,this.parameterResolver=new w(t)}get resolved(){return{boxes:this.resolvedBoxes,dataSources:this.dataSources,meta:this.meta}}get resolvedBoxes(){const{pageProperties:e}=this;return Object.fromEntries(Object.keys(this.boxes).map((t=>{const r=this.boxes[t],n=Object.keys(r).reduce(((e,t)=>{const n=this.parameterResolver.resolve(r[t],t);return Object.assign(e,n)}),{});return[t,Object.assign(n,e)]})))}get pageProperties(){const e={};for(const t in this.meta)0===t.indexOf("$page.")&&(e[t]=this.meta[t]);return e}}function L({href:e},t={}){const r=new URL(e);return r.search=function(e,t){const r=new URLSearchParams(e.search);return Object.entries(t).map((([e,t])=>(Array.isArray(t)?(r.delete(e),t.forEach((t=>r.append(e,t)))):r.set(e,t),r))),r}(r,t).toString(),r.toString()}function M({targetWindow:e,node:t}){var r;const n=e.location.href,o=null===(r=null==t?void 0:t.closest(`[${h}]`))||void 0===r?void 0:r.getAttribute(h),s=new URL(n);return o&&(s.pathname=o),s.href}const D={DEBUG_DATA:{PARSE_ERR:"owb-000001"},COMPONENTS:{LAZY_SCRIPTS:{PARSE_ERR:"owb-00010001",MISSING_BOX:"owb-00010002",MISSING_SCRIPT:"owb-00010003"},SERIALIZED_PROPS:{PARSE_ERR:"owb-00010101"}},PREFERENCES:{WRITE_ERR:"owb-000301",READ_ERR:"owb-000302"},SERVICES:{PARSE_ERR:"owb-000401"}},k={UTILS:{PARSE_ERR:"owb-010001"},CLICK:{MISSING_CONTEXT:"owb-010101",INVALID_CONTEXT:"owb-010102",MISPLACED_CONTEXT:"owb-010103",MISSING_ACTION:"owb-010104",INVALID_ACTION:"owb-010105",MISSING_BOX_OF_CONTEXT_NODE:"owb-010106"},CONTEXT_MENU:{MISSING_CONTEXT:"owb-010201",INVALID_CONTEXT:"owb-010202",MISPLACED_CONTEXT:"owb-010203",MISSING_ACTION:"owb-010204",INVALID_ACTION:"owb-010205",MISSING_BOX_OF_CONTEXT_NODE:"owb-010206"},EVENT:{MISSING_CONTEXT:"owb-010301",INVALID_CONTEXT:"owb-010302",MISPLACED_CONTEXT:"owb-010303",MISSING_ACTION:"owb-010304",INVALID_ACTION:"owb-010305",MISSING_BOX_OF_CONTEXT_NODE:"owb-010306"},ITEM_VIEW:{MISSING_CONTEXT:"owb-010401",INVALID_CONTEXT:"owb-010402",MISPLACED_CONTEXT:"owb-010403",MISSING_ACTION:"owb-010404",INVALID_ACTION:"owb-010405",MISSING_BOX_OF_CONTEXT_NODE:"owb-010406"},BOX_INTERACTION:{MISSING_CONTEXT:"owb-010501",INVALID_CONTEXT:"owb-010502",MISPLACED_CONTEXT:"owb-010503",MISSING_ACTION:"owb-010504",INVALID_ACTION:"owb-010505",MISSING_BOX_OF_CONTEXT_NODE:"owb-010506"},DEFAULT:{MISSING_CONTEXT:"owb-010601",INVALID_CONTEXT:"owb-010602",MISPLACED_CONTEXT:"owb-010603",MISSING_ACTION:"owb-010604",INVALID_ACTION:"owb-010605",MISSING_BOX_OF_CONTEXT_NODE:"owb-010606"}},V={REGISTRY:{LIFECYCLE_ERR:"owb-020101"},SLOTS:{KNOWN_BOX_ERR:"owb-020201",UNKNOWN_BOX_ERR:"owb-020202"}},G={PAGE:{RENDER:{BOX:{MISSING_ID:"owb-03000001"},FRAGMENT:{MISSING_PATHNAME:"owb-03000101",INVALID_PATHNAME:"owb-03000102"},SLOT:{MISSING_BOX_ID:"owb-03000201",INVALID_BOX_ID:"owb-03000202",MISSING_BOX_ENTRY:"owb-03000203",MISSING_SLOT_NAME:"owb-03000204",INVALID_SLOT_NAME:"owb-03000205",MISSING_SLOT_WRAPPER:"owb-03000206",INVALID_SLOT_WRAPPER:"owb-03000207",MISPLACED_SLOT_WRAPPER:"owb-03000208",MISSING_SLOT_CHILDREN:"owb-03000209"}}},COMPONENT:{REGISTER:{MISSING_PROTOTYPE_NAME:"owb-040001",EMPTY_PROTOTYPE_NAME:"owb-040002",INVALID_PROTOTYPE_NAME:"owb-040003",INVALID_IMPLEMENTATION_VERSION:"owb-040004",MISSING_HANDLED_PROTOTYPES:"owb-040005",INVALID_HANDLED_PROTOTYPE:"owb-040006",INVALID_IMPLEMENTATION:"owb-040007",INVALID_ONUPDATE:"owb-040008",MISSING_ONMOUNT:"owb-040009",ALREADY_REGISTERED:"owb-040010",MISSING_IMPLEMENTATION_VERSION:"owb-040011"}},NAVIGATION:{CHANGE_STATE:{INVALID_ARG:"owb-050001"},REGISTER_CHANGE_CALLBACK:{INVALID_ARG:"owb-050101"},REGISTER_CHANGE_STATE_CALLBACK:{INVALID_ARG:"owb-050201"},REMOVE_CHANGE_CALLBACK:{INVALID_ARG:"owb-050301",UNREGISTERED_CALLBACK_REMOVAL:"owb-050302"},REMOVE_CHANGE_STATE_CALLBACK:{INVALID_ARG:"owb-050401",UNREGISTERED_CALLBACK_REMOVAL:"owb-050402"}},REFRESH_PAGE:{NETWORK_ERR:"owb-0601"},CHANGE_PARAMS:{NETWORK_ERR:"owb-0701"},PLUGIN:{REGISTER:{MISSING_CONFIG:"owb-080001",INVALID_NAME:"owb-080002",EMPTY_NAME:"owb-080003",MISSING_IMPLEMENTATION:"owb-080004",UNAVAILABLE:"owb-080005"}},SERVICE:{GET:{LOAD_ERR:"owb-090001"},REGISTER:{INITIALIZATION_ERR:"owb-090101"}}},B="Property 'contextNode' is required!",F="Property 'contextNode' should be a valid HTMLElement!",j="Property 'contextNode' should be a valid HTMLElement contained inside body!",W="Property 'action' is required!",U="Property 'action' must be a string!",X="Could not find box parent of 'contextNode'!",H={[D.DEBUG_DATA.PARSE_ERR]:()=>"Failed to parse page debug data.",[D.COMPONENTS.LAZY_SCRIPTS.PARSE_ERR]:()=>"Lazy scripts: incorrect dependency map JSON",[D.COMPONENTS.LAZY_SCRIPTS.MISSING_BOX]:()=>"Could not find boxEntry by findByNode",[D.COMPONENTS.LAZY_SCRIPTS.MISSING_SCRIPT]:({prototypeId:e,clientImplementationVersion:t})=>`Lazy scripts: Entry not found for "${e}@${t}"`,[D.COMPONENTS.SERIALIZED_PROPS.PARSE_ERR]:({boxName:e,boxId:t,scId:r})=>`There was a problem during deserialization of JSON ${r} ${e} ${t}`,[D.PREFERENCES.WRITE_ERR]:()=>"Error while writing data to storage",[D.PREFERENCES.READ_ERR]:()=>"Error while loading data from storage",[D.SERVICES.PARSE_ERR]:()=>"Error while deserializing JSON",[k.UTILS.PARSE_ERR]:()=>"An error occurred while extracting custom parameters from attributes",[k.CLICK.MISSING_CONTEXT]:()=>B,[k.CLICK.INVALID_CONTEXT]:()=>F,[k.CLICK.MISPLACED_CONTEXT]:()=>j,[k.CLICK.MISSING_ACTION]:()=>W,[k.CLICK.INVALID_ACTION]:()=>U,[k.CLICK.MISSING_BOX_OF_CONTEXT_NODE]:()=>X,[k.CONTEXT_MENU.MISSING_CONTEXT]:()=>B,[k.CONTEXT_MENU.INVALID_CONTEXT]:()=>F,[k.CONTEXT_MENU.MISPLACED_CONTEXT]:()=>j,[k.CONTEXT_MENU.MISSING_ACTION]:()=>W,[k.CONTEXT_MENU.INVALID_ACTION]:()=>U,[k.CONTEXT_MENU.MISSING_BOX_OF_CONTEXT_NODE]:()=>X,[k.EVENT.MISSING_CONTEXT]:()=>B,[k.EVENT.INVALID_CONTEXT]:()=>F,[k.EVENT.MISPLACED_CONTEXT]:()=>j,[k.EVENT.MISSING_ACTION]:()=>W,[k.EVENT.INVALID_ACTION]:()=>U,[k.EVENT.MISSING_BOX_OF_CONTEXT_NODE]:()=>X,[k.ITEM_VIEW.MISSING_CONTEXT]:()=>B,[k.ITEM_VIEW.INVALID_CONTEXT]:()=>F,[k.ITEM_VIEW.MISPLACED_CONTEXT]:()=>j,[k.ITEM_VIEW.MISSING_ACTION]:()=>W,[k.ITEM_VIEW.INVALID_ACTION]:()=>U,[k.ITEM_VIEW.MISSING_BOX_OF_CONTEXT_NODE]:()=>X,[k.BOX_INTERACTION.MISSING_CONTEXT]:()=>B,[k.BOX_INTERACTION.INVALID_CONTEXT]:()=>F,[k.BOX_INTERACTION.MISPLACED_CONTEXT]:()=>j,[k.BOX_INTERACTION.MISSING_ACTION]:()=>W,[k.BOX_INTERACTION.INVALID_ACTION]:()=>U,[k.BOX_INTERACTION.MISSING_BOX_OF_CONTEXT_NODE]:()=>X,[k.DEFAULT.MISSING_CONTEXT]:()=>B,[k.DEFAULT.INVALID_CONTEXT]:()=>F,[k.DEFAULT.MISPLACED_CONTEXT]:()=>j,[k.DEFAULT.MISSING_ACTION]:()=>W,[k.DEFAULT.INVALID_ACTION]:()=>U,[k.DEFAULT.MISSING_BOX_OF_CONTEXT_NODE]:()=>X,[V.REGISTRY.LIFECYCLE_ERR]:({method:e})=>`There was some problem executing "${e}" method on box instance`,[V.SLOTS.KNOWN_BOX_ERR]:({slotList:e,scId:t,boxName:r,prototypeId:n,clientImplementationVersion:o})=>`box - did not render its slots (${e}) server side, blame "${t}" "${r}" "${n}@${o}"`,[V.SLOTS.UNKNOWN_BOX_ERR]:({scId:e,boxName:t,prototypeId:r,clientImplementationVersion:n})=>`unknown box - did not render its slots server side "${e}" "${t} "${r}@${n}"`,[G.PAGE.RENDER.BOX.MISSING_ID]:()=>"Missing 'boxId' property!",[G.PAGE.RENDER.FRAGMENT.MISSING_PATHNAME]:()=>"Missing 'pathname' property!",[G.PAGE.RENDER.FRAGMENT.INVALID_PATHNAME]:()=>"Invalid 'pathname' property!",[G.PAGE.RENDER.SLOT.MISSING_BOX_ID]:()=>"Missing 'boxId' property!",[G.PAGE.RENDER.SLOT.INVALID_BOX_ID]:()=>"'boxId' property must be a string",[G.PAGE.RENDER.SLOT.MISSING_BOX_ENTRY]:()=>"owb-03000203 Could not find box with given 'boxId'!",[G.PAGE.RENDER.SLOT.MISSING_SLOT_NAME]:()=>"Missing 'slotName' property!",[G.PAGE.RENDER.SLOT.INVALID_SLOT_NAME]:()=>"'slotName' property must be an string!",[G.PAGE.RENDER.SLOT.MISSING_SLOT_WRAPPER]:()=>"Missing 'slotWrapper' property!",[G.PAGE.RENDER.SLOT.INVALID_SLOT_WRAPPER]:()=>"Property 'slotWrapper' must be a HTMLElement!",[G.PAGE.RENDER.SLOT.MISPLACED_SLOT_WRAPPER]:()=>"'slotWrapper' property must be Element existing in the document!",[G.PAGE.RENDER.SLOT.MISSING_SLOT_CHILDREN]:()=>"'slotWrapper' does not contain all current children registered with the slot as first level children",[G.COMPONENT.REGISTER.MISSING_PROTOTYPE_NAME]:()=>'Property "handledPrototype" must have "prototypeName" field',[G.COMPONENT.REGISTER.EMPTY_PROTOTYPE_NAME]:()=>'Property "prototypeName" cannot be empty string',[G.COMPONENT.REGISTER.INVALID_PROTOTYPE_NAME]:({type:e})=>`Property "prototypeName" must be string but got ${e}`,[G.COMPONENT.REGISTER.INVALID_IMPLEMENTATION_VERSION]:({type:e})=>`Property "clientImplementationVersion" must be string but got ${e}`,[G.COMPONENT.REGISTER.MISSING_HANDLED_PROTOTYPES]:()=>"Empty handledPrototypes list",[G.COMPONENT.REGISTER.INVALID_HANDLED_PROTOTYPE]:()=>'"handledPrototype" argument must be an object or an array',[G.COMPONENT.REGISTER.INVALID_IMPLEMENTATION]:()=>'"implementation" must be a class',[G.COMPONENT.REGISTER.INVALID_ONUPDATE]:({type:e})=>`"onUpdate" property must be a function or undefined but got ${e}`,[G.COMPONENT.REGISTER.MISSING_ONMOUNT]:()=>'"implementation" class has to have "onMount" method',[G.COMPONENT.REGISTER.ALREADY_REGISTERED]:({prototypeName:e,implementationVersionMessage:t})=>`${e} ${t} already registered!`,[G.COMPONENT.REGISTER.MISSING_IMPLEMENTATION_VERSION]:()=>'Property "clientImplementationVersion" is missing',[G.NAVIGATION.CHANGE_STATE.INVALID_ARG]:()=>"New parameters (array) or hash (string) required",[G.NAVIGATION.REGISTER_CHANGE_CALLBACK.INVALID_ARG]:({type:e})=>`First argument must be a function but got ${e}`,[G.NAVIGATION.REGISTER_CHANGE_STATE_CALLBACK.INVALID_ARG]:({type:e})=>`First argument must be a function but got ${e}`,[G.NAVIGATION.REMOVE_CHANGE_CALLBACK.INVALID_ARG]:({type:e})=>`First argument must be a function but got ${e}`,[G.NAVIGATION.REMOVE_CHANGE_CALLBACK.UNREGISTERED_CALLBACK_REMOVAL]:()=>"Trying to remove unregistered callback",[G.NAVIGATION.REMOVE_CHANGE_STATE_CALLBACK.INVALID_ARG]:({type:e})=>`First argument must be a function but got ${e}`,[G.NAVIGATION.REMOVE_CHANGE_STATE_CALLBACK.UNREGISTERED_CALLBACK_REMOVAL]:()=>"Trying to remove unregistered callback",[G.REFRESH_PAGE.NETWORK_ERR]:()=>"Error while fetching page data",[G.CHANGE_PARAMS.NETWORK_ERR]:()=>"Error while fetching page data",[G.PLUGIN.REGISTER.MISSING_CONFIG]:()=>'Plugin registration error. First argument "config" should be defined',[G.PLUGIN.REGISTER.INVALID_NAME]:()=>'Plugin registration error. Property "name" should be a string',[G.PLUGIN.REGISTER.EMPTY_NAME]:()=>'Plugin registration error. Property "name" should be a non-empty string',[G.PLUGIN.REGISTER.MISSING_IMPLEMENTATION]:()=>'Plugin registration error. Second argument "implementation" is required',[G.PLUGIN.REGISTER.UNAVAILABLE]:({name:e})=>`Plugin registration error. Plugin "${e}" is not allowed to register on this page`,[G.SERVICE.GET.LOAD_ERR]:()=>"Error while trying to inject service scripts",[G.SERVICE.REGISTER.INITIALIZATION_ERR]:()=>"Error while trying to register service implementation"},$="application/vnd.opbox-web.subtree+json";function z(e){return e>=200&&e<300||502===e}class q{constructor({targetWindow:e=window,config:t,httpClient:r,reportError:n,fragmentRenderCallback:o,boxRenderCallback:s,slotRenderCallback:i,componentNodesFinder:a}){this.updateViewId=e=>{this.viewId=e},this.httpClient=r,this.reportError=n,this.targetWindow=e,this.fragmentRenderCallback=o,this.boxRenderCallback=s,this.slotRenderCallback=i,this.render={box:this.renderBox.bind(this),fragment:this.renderFragment.bind(this),slot:this.renderSlot.bind(this)},this.viewId=t.viewId,this.pageRenderingStatus=t.pageRenderingStatus,this.getPageDataAbortController=new AbortController,this.componentNodesFinder=a}getPageData(e){this.getPageDataAbortController.abort(),this.getPageDataAbortController=new AbortController;const t={headers:{Accept:"application/vnd.opbox-web.v2+json"},validateStatus:z,signal:this.getPageDataAbortController.signal};return this.httpClient.get(e,t).then((e=>{const t=new x(e);if(!t.valid)throw new l("Opbox response is invalid.");return new _(t.data)}))}handleError(e,t={}){return this.reportError(e,{errorContext:t}),Promise.reject(e)}renderBox({boxId:e,additionalQueryParameters:t={},isPlaceholder:r=!1}={}){if(!e)return this.handleError(G.PAGE.RENDER.BOX.MISSING_ID);const n=this.componentNodesFinder.findByBoxId(e,r),o=M({targetWindow:this.targetWindow,node:null==n?void 0:n.node});return this.httpClient.get(L({href:o},t),{headers:{Accept:$,"x-box-id":e,"x-view-id":this.viewId,"x-page-rendering-status":this.pageRenderingStatus},validateStatus:z}).then((({data:t})=>this.boxRenderCallback({boxId:e,data:t,isPlaceholder:r})))}renderFragment({pathname:e,additionalQueryParameters:t={}}={}){if(!e)return this.handleError(G.PAGE.RENDER.FRAGMENT.MISSING_PATHNAME);if(!function(e){return!!e.match(new RegExp("^(\\/[a-zA-Z0-9\\-]+)*\\/{0,1}$"))}(e))return this.handleError(G.PAGE.RENDER.FRAGMENT.INVALID_PATHNAME);const{protocol:r,host:n}=this.targetWindow.location,{href:o}=new URL(`${r}//${n}${e}`);return this.httpClient.get(L({href:o},t),{headers:{Accept:$,"x-view-id":this.viewId},validateStatus:z}).then((({data:t})=>this.fragmentRenderCallback({pathname:e,data:t})))}renderSlot({boxId:e,slotName:t,slotWrapper:r,additionalQueryParameters:n={}}={}){if(!e)return this.handleError(G.PAGE.RENDER.SLOT.MISSING_BOX_ID);if("string"!=typeof e)return this.handleError(G.PAGE.RENDER.SLOT.INVALID_BOX_ID);const o=this.componentNodesFinder.findByBoxId(e);if(!(null==o?void 0:o.boxEntry))return this.handleError(G.PAGE.RENDER.SLOT.MISSING_BOX_ENTRY);const s={tags:{scId:o.boxEntry.scId}};if(!t)return this.handleError(G.PAGE.RENDER.SLOT.MISSING_SLOT_NAME,s);if("string"!=typeof t)return this.handleError(G.PAGE.RENDER.SLOT.INVALID_SLOT_NAME,s);if(!r)return this.handleError(G.PAGE.RENDER.SLOT.MISSING_SLOT_WRAPPER,s);if(!p(r))return this.handleError(G.PAGE.RENDER.SLOT.INVALID_SLOT_WRAPPER,s);if(!this.targetWindow.document.contains(r))return this.handleError(G.PAGE.RENDER.SLOT.MISPLACED_SLOT_WRAPPER,s);const i=this.componentNodesFinder.findSlotBoxes(e,t),a=new Set(r.childNodes.values());if(i.some((e=>!a.has(e.node))))return this.handleError(G.PAGE.RENDER.SLOT.MISSING_SLOT_CHILDREN,s);const l=M({targetWindow:this.targetWindow,node:o.node});return this.httpClient.get(L({href:l},n),{headers:{Accept:$,"x-box-id":e,"x-slot-name":t,"x-view-id":this.viewId,"x-page-rendering-status":this.pageRenderingStatus},validateStatus:z}).then((({data:n})=>this.slotRenderCallback({data:n,boxId:e,slotName:t,slotWrapper:r})))}createAPI(){return{render:this.render}}}function Y(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var K,J={exports:{}};var Q=(K||(K=1,J.exports=function(){function e(e){return e instanceof Object&&e.constructor===Object}function t(r,n){var o=r,s=n;e(r)||(o={}),e(n)||(s={});var i=Object.keys(o),a=Object.keys(s),l={};return i.forEach((function(r){-1!==a.indexOf(r)?null===o[r]?l[r]=s[r]:e(o[r])&&e(s[r])?l[r]=t(o[r],s[r]):l[r]=s[r]:l[r]=o[r]})),a.forEach((function(e){-1===i.indexOf(e)&&(l[e]=s[e])})),l}function r(r){var n=r;e(r)||(n={});for(var o=arguments.length,s=new Array(o>1?o-1:0),i=1;i<o;i++)s[i-1]=arguments[i];return s.forEach((function(r){e(r)&&(n=t(n,r))})),n}return r}()),J.exports),Z=Y(Q);const ee=new WeakMap,te=new WeakMap,re=new WeakMap,ne=e=>te.has(e),oe=(e,t,r=0)=>{if(!e||ne(e))return;const n=(parseInt(re.get(e),10)||0)+t;n>=r&&(te.set(e,!0),I(e,"boxView",{bubbles:!0})),re.set(e,n)},se=(e,t,r,n)=>{const o={lowerValue:e,higherValue:t,viewportDimension:r,overrideLength:n};return ee.has(o)||ee.set(o,e>0?e<r?t<r?t-e:r-e:0:t<0?0:t<r?t:e<=0&&t>=r?r:n),ee.get(o)},ie="data-box-name",ae="data-analytics-category",le="data-analytics-tags",ce="data-item",de="light",he=e=>e.replace(/^([A-Z])|[\s|_-](\w)/g,((e,t,r)=>r?r.toUpperCase():t.toLowerCase())),ue=({contextNode:e,stringParamCustomPrefix:t,jsonParamCustomPrefix:r,componentNodesFinder:n,reportError:o=()=>{}})=>{const s={};for(let i=0;i<e.attributes.length;i+=1){const a=e.attributes[i];if(t&&a.name.startsWith(t)){const e=a.name.replace(t,"");s[he(e)]=a.value}if(r&&a.name.startsWith(r)){const t=a.name.replace(r,"");try{s[he(t)]=JSON.parse(a.value)}catch(r){const s=n.getBlameTags(e);o(k.UTILS.PARSE_ERR,{error:r,errorContext:{attributeName:a.name,customParamName:t,tags:s.tags}})}}}return s},Ee=(e,t,r,n)=>{const o=n||t.viewId;return Z(r||t.cookieMonster.defaultCustomParams.pv,Ne(e,t),o?{_opbox:{viewId:o}}:void 0)},pe=({contextNode:e,customParams:t={},reportError:r,componentNodesFinder:n})=>{const o=ue({contextNode:e,stringParamCustomPrefix:"data-analytics-view-opbox-custom-",componentNodesFinder:n,reportError:r}),s=Object.keys(o).length?{_opbox:o}:{};return Z(ue({contextNode:e,stringParamCustomPrefix:"data-analytics-view-custom-",jsonParamCustomPrefix:"data-analytics-view-json-custom-",componentNodesFinder:n,reportError:r}),s,t)},me=({contextNode:e,coordinates:t={},destinationUrl:r="",customParams:n={},isNewTab:o,reportError:s,componentNodesFinder:i})=>{const a=o?{isNewTab:o}:{},l=Object.assign(Object.assign(Object.assign(Object.assign({},ue({contextNode:e,stringParamCustomPrefix:"data-analytics-click-opbox-custom-",componentNodesFinder:i,reportError:s})),{destinationUrl:r}),a),t);return Z(ue({contextNode:e,stringParamCustomPrefix:"data-analytics-click-custom-",jsonParamCustomPrefix:"data-analytics-click-json-custom-",componentNodesFinder:i,reportError:s}),{_opbox:l},n)},ge=({contextNode:e,customParams:t={},reportError:r,componentNodesFinder:n})=>{const o=ue({contextNode:e,stringParamCustomPrefix:"data-analytics-interaction-custom-",jsonParamCustomPrefix:"data-analytics-interaction-json-custom-",componentNodesFinder:n,reportError:r}),s=ue({contextNode:e,stringParamCustomPrefix:"data-analytics-interaction-opbox-custom-",componentNodesFinder:n,reportError:r}),i=Object.keys(s).length?{_opbox:s}:{};return Z(o,i,t)},be=e=>{const t=e.closest(`[${le}]`);if(!t)return[];return((e,t)=>{const r=e.split(","),n=t.split(","),o=r.concat(n);return o.filter(((e,t)=>e&&o.indexOf(e)===t))})(!!t.closest(`[${ce}]`)?(e=>{const t=e&&e.closest(`[${ie}][${le}]`);return t&&t.getAttribute(le)||""})(t):"",t.getAttribute(le)||"")},Ne=(e,t)=>{const r=e.matchMedia("(prefers-color-scheme: dark)").matches?"dark":de;return{systemColorScheme:r,userSelectedColorScheme:t.colorScheme,renderedColorScheme:t.isDarkModeEnabled?r:de,defaultColorScheme:de}},Ie=2e3;function fe({targetWindow:e,onCycleComplete:t}){const r=Date.now,n=r(),o=()=>{const{innerHeight:t,scrollY:r}=e;return t+(r||e.document.documentElement.scrollTop)};let s,i=0,a=0,l=o(),c=0,d=!1;const h=e=>{if(!c)return;let t;if(c<i){const r=e-i,n=Ie-(i-c);t=Math.min(r,n)}else{const r=e-c;t=Math.min(r,Ie)}a+=t},u=()=>{const{body:t,documentElement:r}=e.document;return r.scrollHeight||t.scrollHeight},E=()=>r()-n,p=()=>{d=!1;const e=E();h(e),(()=>{const e=o();e>l&&(l=e)})(),c=e},m=()=>{var e;e=E(),h(e),a>0&&t({engagementTime:Math.min(a,6e3),scrollBottom:l,pageHeight:u()}),c<e-Ie&&(c=0),a=0,i=e,l=o()},{document:g}=e;g.addEventListener("click",p),g.addEventListener("mousemove",p),g.addEventListener("keydown",p),g.addEventListener("scroll",(()=>{d||(d=!0,e.requestAnimationFrame(p))})),e.addEventListener("pagehide",(()=>{e.clearInterval(s),m()})),e.addEventListener("pageshow",(()=>{i=E(),s=e.setInterval(m,6e3)}))}class Ce{constructor({targetWindow:e,config:t,cookieMonsterClient:r,boxViewsMarker:n,reportError:o,componentNodesFinder:s}){this.sendPingEvent=({engagementTime:e,scrollBottom:t,pageHeight:r})=>{const n={category:"Engagement",label:"ping",customParams:{et:e,sb:t,ph:r}};this.cookieMonsterClient.send("event",n),this.callEventCallbacks(n)},this.detectAdblock=()=>{const{document:e}=this,t=Object.assign(e.createElement("div"),{innerHTML:"&nbsp;",className:"adsbox"});e.body.appendChild(t),this.targetWindow.setTimeout((()=>{const r=0!==t.offsetHeight;this.cookieMonsterClient.send("event",{category:"clearPV",action:r,customParams:this.defaultCustomParams.ev}),e.body.removeChild(t)}),100)},this.handleClick=e=>{this.handleBoxInteraction(e),this.handleLinkClick(e)},this.handleLinkClick=e=>{if("function"!=typeof e.target.closest)return;if(this.shouldHandleBoxInteraction(e))return void this.handleBoxInteraction(e);const t=e.target.closest("a");if(!t||!t.hasAttribute("data-analytics-clickable"))return;const r=t.getAttribute("data-analytics-click-label")||"",n=t.getAttribute("data-analytics-click-value")||(t.textContent||"").trim(),o="_blank"===t.getAttribute("target"),s=t.getAttribute("href")||"",i=e.pageX?{pageX:e.pageX,pageY:e.pageY}:{};"click"!==e.type||0!==e.button?"contextmenu"!==e.type?"mousedown"===e.type&&1===e.button&&this.sendClickEvent({contextNode:t,label:r,value:n,customParams:me({contextNode:t,coordinates:i,destinationUrl:s,isNewTab:!0,reportError:this.reportError,componentNodesFinder:this.componentNodesFinder})}):this.sendContextmenuEvent({contextNode:t,label:r,value:n,customParams:me({contextNode:t,coordinates:i,destinationUrl:s,reportError:this.reportError,componentNodesFinder:this.componentNodesFinder})}):this.sendClickEvent({contextNode:t,label:r,value:n,customParams:me({contextNode:t,coordinates:i,destinationUrl:s,isNewTab:o||e.metaKey||e.ctrlKey,reportError:this.reportError,componentNodesFinder:this.componentNodesFinder})})},this.handleChange=e=>{const t=e.target;if("select-one"===t.type&&t&&t.hasAttribute("data-analytics-selectable")){const{value:e}=t.options[t.selectedIndex],r=ue({contextNode:t,stringParamCustomPrefix:"data-analytics-select-custom-",componentNodesFinder:this.componentNodesFinder,reportError:this.reportError});this.sendEvent({contextNode:t,action:"change",value:e,customParams:r})}},this.handleSubmit=e=>{const t=e.target;if(!t||"FORM"!==t.nodeName||!t.hasAttribute("data-analytics-submittable"))return;const r=t.getAttribute("action")||"";let n=Array.from(t.elements).filter((e=>!!e.name)).map((e=>({name:e.name,value:e.value}))).sort(((e,t)=>e.name.toLowerCase().localeCompare(t.name.toLowerCase()))).map((e=>`${e.name}=${e.value}`)).join("&");n=n?`?${n}`:"";let o=n?r+n:r;o=encodeURI(o),this.sendFormSubmitEvent({contextNode:t,value:o,label:"submitForm"})},this.handleBoxView=e=>{var t,r;const n=e.target;if(!n)return;const o=this.componentNodesFinder.findByNode(n);if(!((null===(r=null===(t=null==o?void 0:o.boxEntry)||void 0===t?void 0:t.analytics)||void 0===r?void 0:r.enabled)||n.hasAttribute("data-analytics-enabled"))||(s=n,Array.from(s.childNodes).filter((e=>!!e.classList)).some((e=>e.classList.contains("opbox-fragment")))))return;var s;const i=n.getAttribute("data-analytics-view-value")||"",a=n.getAttribute("data-analytics-view-label")||"";let l=pe({contextNode:n,reportError:this.reportError,componentNodesFinder:this.componentNodesFinder});if(n.firstChild&&n.firstChild.nodeType===Node.ELEMENT_NODE&&(l=Object.assign(Object.assign({},l),ue({contextNode:n.firstChild,stringParamCustomPrefix:"data-analytics-view-custom-",componentNodesFinder:this.componentNodesFinder}))),n.hasAttribute(ce))return this.markParentBoxAsVisible(n),void this.sendItemViewEvent({contextNode:n,label:a,value:i,customParams:l});l=Object.assign(Object.assign({},l),(e=>{if(!e)return{};const t=e.getAttribute("data-analytics-box-view-custom-params");if(!t)return{};let r={};try{r=JSON.parse(decodeURIComponent(t))}catch(e){console.log(e)}return r})(n)),this.sendBoxViewEvent({contextNode:n,value:i,customParams:l})},this.setFragmentAnalyticsContext=(e,t)=>{this.fragmentCustomParams.set(e,t)},this.deleteFragmentAnalyticsContext=e=>{this.fragmentCustomParams.delete(e)};const{cookieMonster:{account:i,isEngagementMeasuringEnabled:a,defaultCustomParams:l={}}={},viewId:c}=t;this.targetWindow=e,this.document=e.document,this.account=i,this.isEngagementMeasuringEnabled=a,this.cookieMonsterClient=r,this.boxViewsMarker=n,this.reportError=o,this.defaultCustomParams=l,this.fragmentCustomParams=new WeakMap,this.config=t,this.viewId=c,this.eventCallbacks=[],this.componentNodesFinder=s;const d=function(e){var t;return(null===(t=null==e?void 0:e.navigator)||void 0===t?void 0:t.userAgent)||""}(e);this.isMobile=function(e){return!!e.match(T)}(d),this.isSafari=function(e){return!!e.match(S)}(d),this.isFirefox=function(e){return e.toLowerCase().includes("firefox")}(d)}initialize(){if(!this.account)return;this.cookieMonsterClient.initialize(),this.isEngagementMeasuringEnabled&&fe({targetWindow:this.targetWindow,onCycleComplete:this.sendPingEvent});const{document:e}=this;e.addEventListener("change",this.handleChange),e.addEventListener("click",this.handleClick,{capture:!0}),e.addEventListener("mousedown",this.handleLinkClick),e.addEventListener("submit",this.handleSubmit),e.addEventListener("contextmenu",this.handleClick),e.addEventListener("boxView",this.handleBoxView),this.targetWindow.addEventListener("DOMContentLoaded",this.detectAdblock)}callEventCallbacks(e){this.eventCallbacks.length&&this.eventCallbacks.forEach((t=>t(e)))}sendEvent({contextNode:e,action:t,label:r="",value:n,customParams:o={}}={},s=k.DEFAULT){let i={action:t,label:r,value:n,customParams:JSON.stringify(o)};if(!e)return this.reportError(s.MISSING_CONTEXT,{errorContext:i});if(!p(e))return this.reportError(s.INVALID_CONTEXT,{errorContext:i});if(!this.targetWindow.document.body.contains(e))return this.reportError(s.MISPLACED_CONTEXT,{errorContext:i});const a=this.componentNodesFinder.findClosestAncestor(e);if(!a)return this.reportError(s.MISSING_BOX_OF_CONTEXT_NODE,{errorContext:i});const{boxEntry:l,node:c}=a;if(l.scId&&(i=Object.assign(Object.assign({},i),{tags:{scId:l.scId}})),!t)return this.reportError(s.MISSING_ACTION,{errorContext:i});if("string"!=typeof t)return this.reportError(s.INVALID_ACTION,{errorContext:i});const{boxName:d,boxId:u,analytics:E}=l,{groups:m=[],tags:g=[],category:b}=E,N=(()=>{const t=e.closest("[data-analytics-category]");return t&&(!b||c.contains(t))?t.getAttribute("data-analytics-category"):b})(),I=e.closest(`[${h}]`),f=Array.from(new Set(be(e).concat(g))),C=f.length?{analyticsTags:f}:{},A=m.length?{groups:m}:{},S=u?{boxName:d,boxId:u}:{boxName:d},T=Object.assign(Object.assign(Object.assign({},C),A),S),v={category:N||"",action:t,label:r,value:n,customParams:Z(Object.assign({},o),{_opbox:T},this.defaultCustomParams.ev,this.getFragmentAnalyticsContext(I))};return this.cookieMonsterClient.send("event",v),this.callEventCallbacks(v),v}sendClickEvent(e){this.sendEvent(Object.assign(Object.assign({},e),{action:"click"}),k.CLICK)}sendContextmenuEvent(e){this.sendEvent(Object.assign(Object.assign({},e),{action:"contextmenu"}),k.CONTEXT_MENU)}sendBoxInteractionEvent(e){this.sendEvent(Object.assign(Object.assign({},e),{action:"boxInteraction"}),k.BOX_INTERACTION)}sendItemViewEvent(e){this.sendEvent(Object.assign(Object.assign({},e),{action:"itemView"}),k.ITEM_VIEW)}sendBoxViewEvent(e){this.sendEvent(Object.assign(Object.assign({},e),{action:"boxView"}))}sendFormSubmitEvent(e){this.sendEvent(Object.assign(Object.assign({},e),{action:"submit"}))}handleBoxInteraction(e){if("function"!=typeof e.target.closest)return;const t=e.target.closest("[data-analytics-interaction]");if(!t)return;const r=ge({contextNode:t,reportError:this.reportError,componentNodesFinder:this.componentNodesFinder}),n=t.getAttribute("data-analytics-interaction-label")||"",o=t.getAttribute("data-analytics-interaction-value")||(t.textContent||"").trim();this.sendBoxInteractionEvent({contextNode:t,label:n,value:o,customParams:r})}shouldHandleBoxInteraction(e){return"mousedown"===e.type&&!this.isMobile&&(this.isSafari||this.isFirefox)&&"select-one"===e.target.type}markParentBoxAsVisible(e){var t;const r=e.parentNode&&(null===(t=e.parentNode)||void 0===t?void 0:t.closest("[data-analytics-enabled]"));this.boxViewsMarker&&r&&!ne(r)&&this.boxViewsMarker.markBoxAsVisible(r,!0)}sendPageViewProxy(){this.account&&(this.cookieMonsterClient.sendPageView(Ee(this.targetWindow,this.config,this.defaultCustomParams.pv,this.viewId)),this.cookieMonsterClient.updateReferrer())}sendEventProxy(e,t,r,n,o){if(!this.account)return null;return e.nodeType===Node.ELEMENT_NODE?this.sendEvent({value:r,label:o,action:t,contextNode:e,customParams:n},k.EVENT):this.sendEvent(e)}sendItemViewEventProxy({contextNode:e,label:t,value:r,customParams:n}){this.account&&this.sendItemViewEvent({contextNode:e,label:t,value:r,customParams:pe({contextNode:e,customParams:n,reportError:this.reportError,componentNodesFinder:this.componentNodesFinder})})}sendClickEventProxy({contextNode:e,label:t,value:r,customParams:n,destinationUrl:o,isNewTab:s}){if(this.account){if(s&&"boolean"!=typeof s)throw new Error("isNewTab property must be boolean");this.sendClickEvent({contextNode:e,label:t,value:r,customParams:me({contextNode:e,destinationUrl:o,customParams:n,isNewTab:s,reportError:this.reportError,componentNodesFinder:this.componentNodesFinder})})}}sendContextmenuEventProxy({contextNode:e,label:t,value:r,customParams:n,destinationUrl:o}){this.account&&this.sendContextmenuEvent({contextNode:e,label:t,value:r,customParams:me({contextNode:e,destinationUrl:o,customParams:n,reportError:this.reportError,componentNodesFinder:this.componentNodesFinder})})}sendBoxInteractionEventProxy({contextNode:e,label:t,value:r,customParams:n}){this.account&&this.sendBoxInteractionEvent({contextNode:e,label:t,value:r,customParams:ge({contextNode:e,customParams:n,reportError:this.reportError,componentNodesFinder:this.componentNodesFinder})})}updateCustomParams({pv:e={},ev:t={}}={},r){this.viewId=r,u(e)&&u(t)?this.defaultCustomParams={pv:e,ev:t}:console.log("Can not update custom params with non-object arguments!")}registerEventCallback(e){this.account&&e&&!this.eventCallbacks.includes(e)&&this.eventCallbacks.push(e)}getFragmentAnalyticsContext(e){return this.fragmentCustomParams.get(e)||{}}createAPI(){return{sendPageView:this.sendPageViewProxy.bind(this),sendEvent:this.sendEventProxy.bind(this),sendItemViewEvent:this.sendItemViewEventProxy.bind(this),sendClickEvent:this.sendClickEventProxy.bind(this),sendContextmenuEvent:this.sendContextmenuEventProxy.bind(this),sendBoxInteractionEvent:this.sendBoxInteractionEventProxy.bind(this),registerEventCallback:this.registerEventCallback.bind(this)}}}function Ae(e,t){var r={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(r[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(n=Object.getOwnPropertySymbols(e);o<n.length;o++)t.indexOf(n[o])<0&&Object.prototype.propertyIsEnumerable.call(e,n[o])&&(r[n[o]]=e[n[o]])}return r}function Se(e,t,r,n){return new(r||(r=Promise))((function(o,s){function i(e){try{l(n.next(e))}catch(e){s(e)}}function a(e){try{l(n.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(i,a)}l((n=n.apply(e,t||[])).next())}))}"function"==typeof SuppressedError&&SuppressedError;const Te=()=>Promise.reject(new Error("missing edge host")),ve="application/vnd.allegro.public.v1+json";class Oe{constructor({httpClient:e,edgeHost:t,config:{language:r,otelTrace:n}}){this.get=(e,t)=>this.httpClient.get(this.prepareRequestUrl(e),this.prepareRequestSettings(t,!0)),this.put=(e,t,r)=>this.httpClient.put(this.prepareRequestUrl(e),t,this.prepareRequestSettings(r)),this.post=(e,t,r)=>this.httpClient.post(this.prepareRequestUrl(e),t,this.prepareRequestSettings(r)),this.patch=(e,t,r)=>this.httpClient.patch(this.prepareRequestUrl(e),t,this.prepareRequestSettings(r)),this.delete=(e,t)=>this.httpClient.delete(this.prepareRequestUrl(e),this.prepareRequestSettings(t,!0)),this.edgeHost=t,this.httpClient=e,this.otelTrace=n,this.defaultHeaders={"Content-Type":ve,Accept:ve,"Accept-Language":r}}prepareRequestSettings(e={},t=!1){if(e.disableDefaultHeaders)return e;const r=this.normalizeSettings(e),n=this.defaultHeaders,{"Content-Type":o}=n,s=Ae(n,["Content-Type"]),i=this.otelTrace?{traceparent:`00-${this.otelTrace.traceId}-${[...crypto.getRandomValues(new Uint8Array(8))].map((e=>e.toString(16).padStart(2,"0"))).join("")}-${this.otelTrace.traceFlags}`}:{};return Z({},t?{headers:s}:{headers:this.defaultHeaders},{headers:i},r)}normalizeSettings(e){if(!e||!e.headers)return e;const t=C(e.headers,Object.keys(this.defaultHeaders));return Object.assign(e,{headers:t})}prepareRequestUrl(e){return this.edgeHost+e}createAPI(){return this.edgeHost?{get:this.get,put:this.put,post:this.post,patch:this.patch,delete:this.delete}:{get:Te,put:Te,post:Te,patch:Te,delete:Te}}}const ye=["_meta_cross_domain_id","_fbc","_fbp","_meta_facebookTag_sync","_meta_tiktok_ttclid","_ttp","_meta_googleGtag_ga","_meta_googleGtag_gcl_aw","_meta_googleGtag_session_id","_meta_ringierAxelSpringerPoland_adp_session","_meta_ringierAxelSpringerPoland_dlapi_aid","_meta_ringierAxelSpringerPoland_dlapi_lu","_meta_rtbHouse_fired"],Pe="cm";class Re{constructor({targetWindow:e,config:t}){this.targetWindow=e,this.config=t}load(e){if(this.cm)return;this.targetWindow["cm.analytics.object"]=Pe;const t=this.targetWindow[Pe],r=this;this.cm=function(...e){var t;((t=r.cm).q||(t.q=[])).push(Array.from(e))},Object.defineProperty(this.targetWindow,Pe,{configurable:!0,set(e){r.cm=e,Object.defineProperty(r.targetWindow,Pe,{writable:!0,configurable:!0,enumerable:!0,value:e})},get:()=>r.cm}),this.attachTrackerJsScript(),e(),Array.isArray(null==t?void 0:t.q)&&t.q.filter((e=>Array.isArray(e)&&e.length>0)).forEach((([e,...t])=>this.callCM(e,...t)))}attachTrackerJsScript(){{const e=this.targetWindow.document.createElement("script");e.src=this.config.cookieMonster.host,this.targetWindow.document.head.appendChild(e)}}callCM(e,...t){this.cm&&this.cm.call(null,e,...t)}send(...e){const t=`send@${this.config.cookieMonster.account}`;this.callCM(t,...Array.from(e))}sendPageView(e){const t=null!=e?e:Ee(this.targetWindow,this.config);this.send("pageview",{customParams:t,referrer:this.referrer,customCookies:ye})}updateReferrer(){this.referrer=window.location.href}initialize(){const{account:e,host:t,encodedUserId:r}=this.config.cookieMonster;t&&e&&!this.cm?(this.load((()=>{this.callCM("create",e,{userId:r}),this.sendPageView()})),this.updateReferrer()):this.updateReferrer()}}const xe="data-analytics-enabled",we="data-analytics-proxied";class _e{constructor({targetWindow:e,boxes:t=[],significantElementSizePercentage:r=.75,significantElementSizeForBiggerThanViewportPercentage:n=.5,timeoutValue:o=500,debounceTimeoutValue:s=20,componentNodesFinder:i}){this.markCurrentlyVisibleElementsAsSeen=()=>{const{timeoutValue:e}=this.config;this.visibleElements.forEach((t=>{oe(t,e,e)}))},this.markPreviouslyVisibleElementAsHidden=e=>{this.visibleElementsByIntersectionObserver.has(e)&&(this.visibleElementsByIntersectionObserver.delete(e),I(e,"outOfViewport"))},this.intersectionHandler=e=>{e.forEach((({target:e,boundingClientRect:t,rootBounds:r})=>{r&&((e,t,r,n)=>{const o=e.right-e.left,s=e.bottom-e.top,i=t.height,a=t.width,l=((e,t)=>(e.top>=t.top&&e.top<=t.bottom||e.bottom<=t.bottom&&e.bottom>=t.top||e.top<t.top&&e.bottom>t.bottom)&&(e.left>=t.left&&e.left<=t.right||e.right<=t.right&&e.right>=t.left||e.left<t.left&&e.right>t.right))(e,t),c=l?se(e.left,e.right,t.width,o):0,d=l?se(e.top,e.bottom,t.height,s):0;return s>i&&d>i*n||o>a&&c>a*n||d*c/(o*s)>r})(t,r,this.config.significantElementSizePercentage,this.config.significantElementSizeForBiggerThanViewportPercentage)?this.visibleElementsByIntersectionObserver.has(e)||(this.visibleElementsByIntersectionObserver.add(e),this.notVisibleElements.delete(e),I(e,"inViewport")):(this.markPreviouslyVisibleElementAsHidden(e),this.notVisibleElements.add(e))})),this.resetCurrentlyVisibleElementsOnTimeout()},this.scrollHandler=()=>{this.state.isScrolling||(this.state.scrollStartTime=(new Date).getTime(),this.state.isScrolling=!0),clearTimeout(this.markCurrentlyVisibleElementsAsSeenOnTimeout()),this.scrollEndHandler()},this.addBox=e=>{null!==e&&-1===this.boxes.indexOf(e)&&(this.boxes.push(e),this.observer.observe(e))},this.isBoxInViewport=e=>this.visibleElementsByIntersectionObserver.has(e),this.markBoxAsRendered=e=>{var t,r,n;return!e.hasAttribute(xe)&&!(null===(n=null===(r=null===(t=this.componentNodesFinder.findByNode(e))||void 0===t?void 0:t.boxEntry)||void 0===r?void 0:r.analytics)||void 0===n?void 0:n.enabled)||e.closest(`[${we}]`)||this.addBox(e),this.getBoxViewEnabledNodes(e).filter((t=>t!==e)).forEach(this.addBox),Promise.resolve()},this.markBoxAsVisible=(e,t=!1)=>{if(this.addBox(e),t){const{timeoutValue:t}=this.config;oe(e,t,t)}},this.recursivelyMarkBoxAsVisible=(e,t=!1)=>{this.getBoxViewEnabledNodes(e).forEach((e=>this.markBoxAsVisible(e,t)))},this.removeBox=(e,t)=>{null!==e&&(this.markPreviouslyVisibleElementAsHidden(e),((e,t=!0)=>{t&&te.delete(e),re.delete(e)})(e,t),this.boxes=this.boxes.filter((t=>t!==e)),this.visibleElements=this.visibleElements.filter((t=>t!==e)),this.observer.unobserve(e))},this.markBoxAsHidden=e=>{this.removeBox(e,!1),this.resetCurrentlyVisibleElementsOnTimeout()},this.unmountNode=e=>{this.getAllBoxViewEnabledNodes(e).forEach((e=>this.removeBox(e,!0)))},this.recursivelyMarkBoxAsHidden=e=>{this.getBoxViewEnabledNodes(e).forEach(this.markBoxAsHidden)},this.trackBoxScroll=e=>{e.addEventListener("scroll",this.scrollHandler)},this.componentNodesFinder=i,this.targetWindow=e,this.document=e.document,this.config={timeoutValue:o,debounceTimeoutValue:s,significantElementSizePercentage:r,significantElementSizeForBiggerThanViewportPercentage:n},this.resetState(),this.boxes=t.length?t:this.getBoxViewEnabledNodes(e.document),this.visibleElements=[],this.visibleElementsByIntersectionObserver=new Set,this.notVisibleElements=new Set,this.observer=new e.IntersectionObserver(this.intersectionHandler,{threshold:[0,.1,.2,.3,.4,.5,.6,.7,.8,.9,1]}),this.scrollEndHandler=N(this.resetCurrentlyVisibleElementsAfterScroll,s),this.resetCurrentlyVisibleElementsOnTimeout=function(e,t){let r;return function(...n){return new Promise((o=>{clearTimeout(r),r=setTimeout((()=>{r=null,o(e.apply(this,n))}),t)}))}}(this.resetCurrentlyVisibleElements.bind(this),s),this.markCurrentlyVisibleElementsAsSeenOnTimeout=N(this.markCurrentlyVisibleElementsAsSeen,o)}resetState(){const e=Date.now();this.state={isScrolling:!1,scrollStartTime:e,counterStartTime:e}}getAllBoxViewEnabledNodes(e){var t;const r=Array.from(e.querySelectorAll(`[${xe}]`)),n=this.componentNodesFinder.findSubtree(e).map((e=>e.node)),o=new Set(r.concat(...n));return void 0!==(null===(t=e.dataset)||void 0===t?void 0:t.analyticsEnabled)&&o.add(e),Array.from(o)}getBoxViewEnabledNodes(e){const t=Array.from(e.querySelectorAll(`[${we}]`)).reduce(((e,t)=>{const r=this.getAllBoxViewEnabledNodes(t).filter((t=>!e.includes(t)));return r.length?e.concat(r):e}),[]);return this.getAllBoxViewEnabledNodes(e).filter((e=>!t.includes(e)))}markPreviouslyVisibleElementsAsSeen(){const e=Date.now();this.visibleElements.forEach((t=>{oe(t,e-this.state.counterStartTime,this.config.timeoutValue)}))}markPreviouslyVisibleElementsAsSeenAfterScroll(){this.visibleElements.forEach((e=>{oe(e,this.state.scrollStartTime-this.state.counterStartTime,this.config.timeoutValue)}))}resetCurrentlyVisibleElements(){this.markPreviouslyVisibleElementsAsSeen(),this.visibleElements=[],this.visibleElementsByIntersectionObserver.forEach((e=>this.visibleElements.push(e))),this.markCurrentlyVisibleElementsAsSeenOnTimeout(),this.resetState()}resetCurrentlyVisibleElementsAfterScroll(){this.markPreviouslyVisibleElementsAsSeenAfterScroll(),this.notVisibleElements.forEach((e=>{this.observer.unobserve(e),this.observer.observe(e)})),this.markCurrentlyVisibleElementsAsSeenOnTimeout(),this.resetState()}initialize(){this.targetWindow.addEventListener("scroll",this.scrollHandler),this.boxes.forEach((e=>this.observer.observe(e)))}createAPI(){return{markBoxAsRendered:this.markBoxAsRendered,markBoxAsVisible:this.markBoxAsVisible,recursivelyMarkBoxAsVisible:this.recursivelyMarkBoxAsVisible,markBoxAsHidden:this.markBoxAsHidden,recursivelyMarkBoxAsHidden:this.recursivelyMarkBoxAsHidden,trackBoxScroll:this.trackBoxScroll,isBoxInViewport:this.isBoxInViewport}}}function Le(e,t){const r=function(e){return e.replace("?","").split("&").filter(Boolean).map((e=>e.split("="))).reduce(((e,[t,r])=>(e[t]?e[t].push(r):e[t]=[r],e)),{})}(e);return Object.entries(r).filter((([e])=>{const r=e.replace(/\+/g,"%20");return!Object.keys(t).map((e=>encodeURIComponent(e))).includes(r)})).map((([e,t])=>t.map((t=>`${e}=${null!=t?t:""}`)).join("&")))}function Me([e,t]){return null==t||0===t.length?"":Array.isArray(t)?t.map((t=>`${encodeURIComponent(e)}=${encodeURIComponent(t)}`)).join("&"):`${encodeURIComponent(e)}=${encodeURIComponent(t)}`}function De(e,t=[]){const r=Object.fromEntries(t.map((({name:e,value:t})=>[e,t]))),n=Le(e,r),o=function(e){return Object.entries(e).map(Me).filter(Boolean)}(r),s=[...n,...o].join("&");return s?`?${s}`:""}class ke{constructor({targetWindow:e,opboxWebClient:t,analytics:r,debugData:n,updateViewIdCallback:o,updateComponentCallback:s,beforeUpdateComponentCallback:i,reportError:a}){this.navigateRelative=(e,{persistHash:t=!1,shouldReplaceState:r=!1}={})=>{const n=new URL(this.location.href),o=this.location.search;t||(n.hash="");const s=De(o,null==e?void 0:e.filter((e=>!e.fetchUrlOnly))),i=De(o,e),a=n.pathname+s+n.hash;return i!==this.lastFetchParams&&this.fetch(i,G.CHANGE_PARAMS.NETWORK_ERR),s!==o&&(this.changeUrl(a,r),this.changeCallbacks.forEach((e=>e())),this.targetWindow.performance.mark("clientSideNavigationStart")),a},this.refreshPage=()=>{this.fetch(this.location.search,G.REFRESH_PAGE.NETWORK_ERR)},this.changeState=({queryParameters:e,hash:t,shouldChangeHistory:r})=>{if(!e&&"string"!=typeof t)return this.reportError(G.NAVIGATION.CHANGE_STATE.INVALID_ARG),null;const n=new URL(this.location.href),o=null==e?void 0:e.filter((e=>!e.fetchUrlOnly)),s=this.location.search;n.search=De(s,o),"string"==typeof t&&(n.hash=t);const i=this.location.pathname+n.search+n.hash;return n.href!==this.location.href&&(this.changeUrl(i,!r),this.changeStateCallbacks.forEach((e=>e()))),i},this.registerChangeCallback=e=>{this.registerCallback(e,this.changeCallbacks,G.NAVIGATION.REGISTER_CHANGE_CALLBACK.INVALID_ARG)},this.registerChangeStateCallback=e=>{this.registerCallback(e,this.changeStateCallbacks,G.NAVIGATION.REGISTER_CHANGE_STATE_CALLBACK.INVALID_ARG)},this.removeChangeCallback=e=>{this.changeCallbacks=this.removeCallback(e,this.changeCallbacks,G.NAVIGATION.REMOVE_CHANGE_CALLBACK)},this.removeChangeStateCallback=e=>{this.changeStateCallbacks=this.removeCallback(e,this.changeStateCallbacks,G.NAVIGATION.REMOVE_CHANGE_STATE_CALLBACK)},this.targetWindow=e,this.location=e.location,this.opboxWebClient=t,this.analytics=r,this.debugData=n,this.updateViewIdCallback=o,this.updateComponentCallback=s,this.beforeUpdateComponentCallback=i,this.reportError=a,this.lastFetchParams=this.location.search,this.changeCallbacks=[],this.changeStateCallbacks=[]}initialize(){this.targetWindow.addEventListener("popstate",(e=>this.handlePopState(e)))}changeUrl(e,t=!1){t?this.targetWindow.history.replaceState("","",e):this.targetWindow.history.pushState("","",e)}handlePopState(e){const t=e.target.location.search;this.lastFetchParams!==t&&this.refreshPage()}fetch(e,r){const n=this.location.pathname+e;return this.lastFetchParams=e,this.beforeUpdateComponentCallback(),this.opboxWebClient.getPageData(n).then((e=>this.onDataChange(e))).catch((e=>{e.message!==t&&this.reportError(r,{error:e,errorContext:{path:n}})}))}onDataChange(e){const{boxes:t,meta:r}=e.resolved,{defaultCustomParams:n,viewId:o}=r;this.analytics.updateCustomParams(n,o),this.updateViewIdCallback(o),((e,t)=>{const r=e.document.querySelector('head meta[name="robots"]');r&&t&&r.setAttribute("content",[t.noindexCondition?"noindex":"index",t.nofollowCondition?"nofollow":"follow"].join(", "))})(this.targetWindow,r),Object.entries(t).forEach((([e,t])=>{void 0!==t&&this.updateComponentCallback(e,t)})),this.debugData.onRawDataChange(e)}registerCallback(e,t=[],r){"function"!=typeof e?this.reportError(r,{messageData:{type:typeof e}}):t.push(e)}removeCallback(e,t=[],{INVALID_ARG:r,UNREGISTERED_CALLBACK_REMOVAL:n}){if("function"==typeof e){const r=t.filter((t=>t!==e));return r.length===t.length&&this.reportError(n),r}return this.reportError(r,{messageData:{type:typeof e}}),t}createAPI(){return{registerChangeCallback:this.registerChangeCallback,registerChangeStateCallback:this.registerChangeStateCallback,removeChangeCallback:this.removeChangeCallback,removeChangeStateCallback:this.removeChangeStateCallback,changeState:this.changeState}}}const Ve=500,Ge="opboxAnimationTimerInterval",Be={easeInOutQuart:e=>e<.5?8*e*e*e*e:1-8*--e*e*e*e};function Fe(e,t,r,n,{duration:o=Ve,onFinish:s}={}){if("function"!=typeof n)return null;const i=O(),a=r-t;let l=t,c=!1;const d=()=>{const h=O()-i;if(c||h>=o)l===r||n(r),"function"==typeof s&&s(),c=!1;else{const r=Math.min(h/o,1);l=Be.easeInOutQuart(r)*a+t,n(l),e.requestAnimationFrame(d)}};return d(),{stop:()=>{c=!0}}}function je(e,t=0,{duration:r=Ve}={}){const n=e.scrollY,o=Math.max(0,t),s=e.document.body.scrollHeight;function i(){e[Ge]&&"function"==typeof e[Ge].stop&&(e[Ge].stop(),e[Ge]=null)}i(),e[Ge]=Fe(e,n,t,(t=>{e.scrollTo(0,Math.round(t)),function(t){const r=t===o||t===o,n=e.innerHeight+t>=s;return r||n}(t)&&i()}),{duration:r})}var We=(e,t)=>{const{document:r}=e,n=(n,{animate:o=!0}={})=>{const s={duration:o?500:0};if("number"==typeof n)return void je(e,n,s);const i=(a=n,null===(l=t.findBySlug(a))||void 0===l?void 0:l.node);var a,l;if(i){const t=(t=>{const n=e.scrollY||r.documentElement.scrollTop||0;return t.getBoundingClientRect().top+n})(i);je(e,t,s)}};return{scrollTo:n,scrollToLocationHash:()=>{if(e.location.hash){const t=e.location.hash.substring(1);n(t,{animate:!1})}},tween:(...t)=>Fe(e,...t)}};class Ue{constructor(){this.status=1,this.promise=new Promise((e=>{this.resolve=e}))}registerImplementation(e){this.status=2,this.resolve(e)}}class Xe{constructor({reportError:e,allowedPlugins:t=[]}){this.addPluginToRegistry=({name:e})=>{this.isPluginAvailable(e)||this.pluginsRegistry.set(e,new Ue)},this.register=(e,t)=>{if(!e)return void this.reportError(G.PLUGIN.REGISTER.MISSING_CONFIG);const{name:r}=e;if("string"!=typeof r)return void this.reportError(G.PLUGIN.REGISTER.INVALID_NAME);if(!r)return void this.reportError(G.PLUGIN.REGISTER.EMPTY_NAME);if(!t)return void this.reportError(G.PLUGIN.REGISTER.MISSING_IMPLEMENTATION);const n=this.pluginsRegistry.get(r);n?2!==n.status?n.registerImplementation(t):console.error(`Plugin "${r}" is already registered on page`):this.reportError(G.PLUGIN.REGISTER.UNAVAILABLE,{messageData:{name:r}})},this.getPlugin=e=>{const t=this.pluginsRegistry.get(e);return t?t.promise:Promise.reject(new Error(`Plugin "${e}" is unavailable`))},this.updateRegistry=(e=[])=>{e.forEach(this.addPluginToRegistry)},this.reportError=e,this.pluginsRegistry=new Map,this.boundUpdateRegistry=this.updateRegistry,this.updateRegistry(t)}isPluginAvailable(e){return this.pluginsRegistry.has(e)}createAPI(){return{register:this.register,get:this.getPlugin}}}function He(e,t){return t.filter((t=>{return!e.find((r=t,e=>{if(r.url)return[e.url,e.href,e.src].includes(r.url);if(r.code){const{attributes:t={}}=r,n=!Object.keys(t).some((r=>{var n;return t[r]!==(null===(n=e.node)||void 0===n?void 0:n.getAttribute(r))}));return r.code===e.code&&n}return!1}));var r}))}function $e(e,t,r,n){if(!t.length)return Promise.resolve();const o=function(e){return Array.from(e.document.getElementsByTagName("script"),(e=>({src:e.src,code:e.innerHTML,nonce:e.nonce,node:e})))}(e),s=function(e){return(e.find((({nonce:e})=>!!e))||{}).nonce}(o),i=He(o,t),[a,l]=i.reduce(((e,t)=>(e[t.async?0:1].push(t),e)),[[],[]]),c=function(e,t,r=b,n=b){const{document:o}=e,s=y(e);return({url:e,code:i,attributes:a,type:l})=>e||i?new Promise((c=>{var d;const h=!e&&!!i,u="module"===l,E=o.createElement("script");let p=null,m=!1;const g=t=>{c(),n(new Error(`Error while loading script "${e}": ${JSON.stringify(t)}`)),E.removeEventListener("error",g)},b=()=>{c(),E.removeEventListener("error",g),E.removeEventListener("load",b)};if(!u||s){if(a){if(a.nomodule&&s)return void c();Object.entries(a).forEach((([e,t])=>{"data-serialize-box-id"!==e&&"data-serialize-box-name"!==e||(m=!0,p=o.querySelector(`[${e}="${t}"]`)),E.setAttribute(e,String(t))}))}t&&E.setAttribute("nonce",t),l&&(E.type=l),h?(E.innerHTML=i,c()):(E.src=e||"",E.addEventListener("load",b),E.addEventListener("error",g)),p?null===(d=p.parentNode)||void 0===d||d.replaceChild(E,p):o.head.appendChild(E),m&&r()}else c()})):Promise.resolve()}(e,s,r,n),d=(...e)=>Se(this,[...e],void 0,(function*(e=[]){if(!e.length)return Promise.resolve();const[t,...r]=e;return yield c(t),d(r)}));return d(l).then((()=>Promise.all(a.map(c))))}class ze{constructor({assetUrls:e,reportError:t}){this.assetUrls=e,this.reportError=t,this.implementation=null,this.status=0,this.promise=new Promise(((e,t)=>{this.resolve=e,this.reject=t}))}registerImplementation(e){try{this.implementation=new e,this.status=2,this.resolve(this.implementation)}catch(e){this.handleError(G.SERVICE.REGISTER.INITIALIZATION_ERR,e)}}fetchIfNotFetched(e){if(0===this.status){this.status=1;const{module:t,nomodule:r}=this.assetUrls;$e(e,[y(e)?{url:t,type:"module"}:{url:r}]).catch((e=>{this.handleError(G.SERVICE.GET.LOAD_ERR,e)}))}}handleError(e,t){this.reportError(e,{error:t}),this.status=2,this.reject()}}class qe{constructor({targetWindow:e,reportError:t}){this.register=({serviceName:e},t)=>{this.servicesRegistry.get(e).registerImplementation(t)},this.reportError=t,this.servicesRegistry=new Map;const r=e.document.querySelector('script[data-config="services"]');if(r)try{JSON.parse(r.textContent).forEach((([e,{nomodule:t,module:r}])=>{this.setServiceToRegistry(e,{nomodule:t,module:r})}))}catch(e){this.reportError(D.SERVICES.PARSE_ERR,{error:e})}this.get=function(e,t){return r=>{const n=e.get(r);return n?(n.fetchIfNotFetched(t),n.promise):Promise.reject(new Error(`Service ${r} is not registered`))}}(this.servicesRegistry,e),this.servicesForComponent=Object.freeze({get:this.get})}getServicesForComponent(){return this.servicesForComponent}setServiceToRegistry(e,t){this.servicesRegistry.set(e,new ze({assetUrls:t,reportError:this.reportError}))}createAPI(){return{register:this.register,get:this.get.bind(this),__dangerouslyGet__:this.get.bind(this)}}}function Ye(e,t){e.forEach((({args:e,reject:r,resolve:n})=>{const o=function(e,t){try{return e(...t)}catch(e){return void console.error(e)}}(t,e);o&&"function"==typeof o.then&&"function"==typeof n&&"function"==typeof r&&o.then(n,r)}))}function Ke(e,t,r,...n){if("function"==typeof e&&"function"==typeof t){if(!e.__queue__)return;Ye(e.__queue__,t),r(t,...n)}else u(e)&&u(t)&&Object.keys(e).forEach((o=>{Ke(e[o],t[o],r,...n.concat(o))}))}class Je{constructor({reportError:e,ttlMs:t=2592e6,key:r="opbox.preferences",timeProvider:n=O}){this.savePreferences=e=>{const t=this.loadPreferences(),r=this.timeProvider(),n=e.reduce(v((({name:e,value:t})=>({[e]:{value:t,timestamp:r}}))),t);this.writeToStorage(n)},this.writeToStorage=e=>{try{window.localStorage.setItem(this.key,JSON.stringify(e))}catch(e){this.reportError(D.PREFERENCES.WRITE_ERR,{error:e})}},this.loadPreferences=()=>{try{return JSON.parse(window.localStorage.getItem(this.key))||{}}catch(e){return this.reportError(D.PREFERENCES.READ_ERR,{error:e}),{}}},this.cleanupPreferences=()=>{const e=this.loadPreferences(),t=this.timeProvider(),r=Object.entries(e).reduce(v((([e,r])=>r.timestamp+this.ttlMs>t?{[e]:r}:{})),{});this.writeToStorage(r)},this.ttlMs=t,this.key=r,this.timeProvider=n,this.reportError=e}}class Qe{savePreferences(){}loadPreferences(){return{}}cleanupPreferences(){}}const Ze="/preferences",et="illegal argument type provided as preferences",tt={withCredentials:!0,headers:{"Content-Type":"application/vnd.allegro.internal.v1+json",Accept:"application/vnd.allegro.internal.v1+json"}};class rt{constructor({edgeClient:e,ttlMs:t,reportError:r}){this.setPreference=(e,t)=>{const r={name:e,value:t};return this.storage.savePreferences([r]),this.edgeClient.post(Ze,r,tt)},this.getPreference=(e,t)=>"string"==typeof e||e instanceof String?this.getPreferences({[e]:t}).then((t=>t[e])):Promise.reject(Error("illegal argument type provided as preference name")),this.setPreferences=e=>{if(!u(e))return Promise.reject(Error(et));const t=Object.entries(e).map((([e,t])=>({name:e,value:t})));return this.storage.savePreferences(t),this.edgeClient.post("/preferences/multi",JSON.stringify(t),tt).then((e=>e.data))},this.getPreferences=e=>{if(!u(e))return Promise.reject(Error(et));const t=Object.keys(e).join(","),r=`${Ze}?name=${t}`,{withCredentials:n}=tt,o=tt.headers,{"Content-Type":s}=o,i=Ae(o,["Content-Type"]);return this.edgeClient.get(r,{withCredentials:n,headers:i}).then((({data:{preferences:e}})=>(this.storage.savePreferences(e),e.reduce(v((({name:e,value:t})=>({[e]:t}))),{})))).catch((()=>this.getPreferencesFromLocalStorageOrDefaults(e)))},this.getPreferencesFromLocalStorageOrDefaults=e=>{this.storage.cleanupPreferences();const t=this.storage.loadPreferences();return Object.entries(e).reduce(v((([e,r])=>({[e]:e in t?t[e].value:r}))),{})},this.edgeClient=e,this.storage=function(){try{const e="test_preferences_storage",{localStorage:t}=window;return t.setItem(e,e),t.getItem(e),t.removeItem(e),!0}catch(e){return!1}}()?new Je({ttlMs:t,reportError:r}):new Qe}createAPI(){return{set:this.setPreference,get:this.getPreference,setMany:this.setPreferences,getMany:this.getPreferences}}}const nt=(e,t)=>{const{document:{documentElement:{clientWidth:r,clientHeight:n}},navigator:{userAgent:o}}=e,{downlink:s}=function({navigator:{connection:e,mozConnection:t,webkitConnection:r}}){return e||t||r||{}}(e),i=`${r}x${n}`,a=!E(t);return Object.assign(Object.assign({device:{viewport:i,ua:o}},a&&{other:t}),s&&{connection:{speed:s}})},ot="#svg-color-matrix-filters";var st=["assets","spinner","button","link","badge","brand","bubble","card","chart","desk","divider","heading","hint","icon","indicator","input","list","timeline","timer","marker","notification","placeholder","price","progress","table","dropdown","breadcrumb","accordion","carousel","chip","choice","dialog","field","image-tile","input-group","message","modal","pagination","range","select","sheet","slider","soap","stepper","switch","tabs","typography","color","grid","board","calendar","datepicker","attachment","article","navigation-tiles","pin","player-video","tip","align","border","box-sizing","display","flex","height","margin","outline","padding","position","transition","utils","visibility","white-space","width","zindex","core"];function it(e,t,r){const n=e.querySelector(r.selectors.bundledStylesMap);if(!n)return[];const{textContent:o}=n;if(!o)return t(new Error("Bundled styles map: empty content")),[];try{return JSON.parse(o)}catch(e){const r=o.slice(0,100),n=o.slice(-100);return t(new Error(`Bundled styles map: invalid JSON. Message: ${e.message}. Length: ${o.length}. Start: ${r}. End: ${n}`)),[]}}const at=["crossOrigin"];const lt=(e,{href:t,media:r,crossOrigin:n},o)=>{const s=function({document:e},t,{referenceNode:r=null}={}){return n=>{A(n,((e,t)=>!(t||at.includes(e))));const o=Object.assign(e.createElement("link"),n);return o.rel=t,r?r.insertAdjacentElement("afterend",o):e.head.appendChild(o),o}}(e,"stylesheet",{referenceNode:o})(Object.assign({type:"text/css",href:t,media:r},{crossOrigin:n}));return new Promise(((e,t)=>{s.addEventListener("error",t),s.addEventListener("load",e)}))},ct=e=>t=>{var r;return!!(null===(r=t.href)||void 0===r?void 0:r.includes(`${e}/`))},dt=(e,t,r)=>{var n,o,s;const i=e.filter((e=>e.isMetrum)),a=t.slice(0,t.indexOf(r)).reverse().find((e=>i.find(ct(e)))),l=a&&(null===(n=i.find(ct(a)))||void 0===n?void 0:n.node)||null;return!l&&i.length?null===(o=i[0].node)||void 0===o?void 0:o.previousElementSibling:!l&&e.length?null===(s=e[0].node)||void 0===s?void 0:s.previousElementSibling:l};function ht(e,t){return e.findIndex((e=>e.selectorText===t))}function ut(e,{cssBundle:{isEnabled:t,emptyRule:r}},n,o){const s=t?function(e){return Array.from(e.document.styleSheets).find((({ownerNode:e})=>{var t;return null===(t=null==e?void 0:e.hasAttribute)||void 0===t?void 0:t.call(e,"data-metrum-bundle")}))}(e):null;let i=[];const a=e=>r.pattern.replace(r.replacementPart,e);return{isEnabled:t,inject(r){if(!t)return Promise.resolve();const[l,c]=function(e,t){return t.reduce((([t,r],n)=>(e.includes(n)||r.push(n),t.push(n),[t,r])),[[],[]])}(i,r);return i=l,c.length?function(e,t){const r=e.createDocumentFragment(),n=t.map((t=>Object.assign(e.createElement("link"),{type:"text/css",rel:"stylesheet",crossOrigin:"",href:t,media:"not all"}))),o=n.map((e=>new Promise(((t,n)=>{e.addEventListener("load",(()=>{t(e.sheet)})),e.addEventListener("error",n),r.appendChild(e)})))),s=()=>{n.forEach((e=>{e.remove()}))};return e.head.appendChild(r),Promise.all(o).then((e=>[e,s]))}(e.document,c).then((([e,t])=>{e.forEach((e=>{if(!s)return void o(new Error(`Received invalid metrum bundle ${s}`));const t=Array.from(s.cssRules),r=t.length;if(function(e,t){return t.cssRules.length>0&&e.findIndex((e=>e.cssText===t.cssRules[0].cssText))>-1}(t,e))return;const i=g(e.href),l=n.indexOf(i),c=-1!==l?n.slice(l):[];let d=r;for(let e=0;e<c.length;e+=1){const r=ht(t,a(c[e]));if(r>0){d=r;break}}const h=Array.from(e.cssRules);h.unshift({cssText:`${a(i)}{}`});for(let e=0;e<h.length;e+=1)s.insertRule(h[e].cssText,d+e)})),t()})):Promise.resolve()}}}function Et(e,t,r){const n=e.document.createDocumentFragment(),o=r.map((r=>{if(m(r.url))return function(e,t,{href:r,media:n},o){const s=g(r);return o.includes(s)?lt(e,{href:r,media:n,crossOrigin:""},dt(t,o,s)):Promise.resolve()}(e,t,{href:r.url,media:r.media},st);if(r.url){const t=Object.assign(e.document.createElement("link"),Object.assign({type:"text/css",rel:"stylesheet",crossOrigin:"",href:r.url},r.media?{media:r.media}:{}));return n.appendChild(t),new Promise(((e,r)=>{t.addEventListener("error",(()=>r(new Error("Loading external styles failed")))),t.addEventListener("load",e)}))}return r.code?(n.appendChild(Object.assign(e.document.createElement("style"),{textContent:r.code})),Promise.resolve()):Promise.reject(new Error("Given styles have empty code/href"))}));return e.document.head.appendChild(n),Promise.all(o)}let pt;function mt({targetWindow:e,webResponse:t,config:r,errorReporter:n}){const{svgColorMatrixFilters:o="",assets:{styles:s=[]}={}}=t;return function({document:e},t){if(!t)return;const r=e.querySelector(ot),n=e.createElement("div");n.innerHTML=t;const o=n.querySelector("svg");if(!o)throw new Error(`Failed to find svg element in html ${t}`);r?o.querySelectorAll("filter").forEach((e=>{r.querySelector(`#${e.getAttribute("id")}`)||r.appendChild(e)})):e.body.insertBefore(o,e.body.firstChild)}(e,o),function(e,t,r,n){if(!t.length)return Promise.resolve();const o=[...(s=e.document,Array.from(s.querySelectorAll('link[type="text/css"],style'),(e=>({href:e.href,code:e.innerHTML,media:e.media,node:e,isMetrum:m(e.href)}))).filter((({href:e,code:t})=>e||t))),...it(e.document,n,r)];var s;const i=He(o,t);pt=pt&&!pt.forceRefresh?pt:ut(e,r,st,n);const{inject:a,isEnabled:l}=pt,[c,d]=i.reduce(((e,t)=>m(t.url)&&l?(e[0].push(t.url),e):(e[1].push(t),e)),[[],[]]);return Promise.all([Et(e,o,d),a(c)])}(e,s,r,n)}function gt({targetWindow:e,webResponse:t,updateSerializedPropsCollectionCallback:r,errorReporter:n}){const{assets:{scripts:o=[]}={}}=t;return $e(e,o,r,n)}var bt=({config:e,targetWindow:t,unmountNodeCallback:r,mountNodeCallback:n,updateAllowedPluginsCallback:o,updateSerializedPropsCollectionCallback:s,updateComponentNodesCollectionCallback:i,updateDebugDataCallback:a,injectStylesAndFilters:l=mt,injectScripts:c=gt,componentNodesFinder:d,errorReporter:h})=>{const{document:u}=t;return({boxId:E,data:p,isPlaceholder:m})=>{const{htmlString:g="",allowedPlugins:b=[],debugData:N,boxEntries:I=[]}=p||{};return o(b),l({targetWindow:t,webResponse:p,config:e,errorReporter:h}).then((()=>{const e=d.findByBoxId(E,m);if(!e)throw Error("could not find placeholder node / node to replace in subtree rerender");const{node:t}=e;r(t);const n=t.parentNode;if(!g)return null==n||n.removeChild(t),{shouldMountNode:!1,nodes:[]};const o=Object.assign(u.createElement("div"),{innerHTML:g}),s=Array.from(o.children);return t.replaceWith(...s),{shouldMountNode:!0,nodes:s}})).then((({shouldMountNode:e,nodes:r})=>(i(I),c({targetWindow:t,webResponse:p,updateSerializedPropsCollectionCallback:s,errorReporter:h}).then((()=>{e&&r.forEach((e=>n(e)))}))))).then((()=>{N&&a(N,E)}))}},Nt=({config:e,targetWindow:t,unmountNodeCallback:r,mountNodeCallback:n,updateAllowedPluginsCallback:o,updateSerializedPropsCollectionCallback:s,updateComponentNodesCollectionCallback:i,updateDebugDataCallback:a,injectStylesAndFilters:l=mt,injectScripts:c=gt,setFragmentAnalyticsContext:d,deleteFragmentAnalyticsContext:u,errorReporter:E})=>{const{document:p}=t;function m(e){return p.querySelector(`[${h}="${e}"]`)}function g(e,t,r){const n=Object.assign(p.createElement("div"),{innerHTML:t});return n.setAttribute(h,e),r&&d(n,r),n}return({pathname:d,data:h})=>{const{htmlString:b="",allowedPlugins:N=[],analyticsContext:I={},debugData:f,boxEntries:C=[]}=h||{};return o(N),l({targetWindow:t,webResponse:h,config:e,errorReporter:E}).then((()=>{const e=m(d);if(!e&&b){const e=g(d,b,I);return p.body.appendChild(e),!0}if(e){if(r(e),u(e),!b)return e.parentNode.removeChild(e),!1;const t=g(d,b,I);return e.parentNode.replaceChild(t,e),!0}return!1})).then((e=>{i(C),c({targetWindow:t,webResponse:h,updateSerializedPropsCollectionCallback:s,errorReporter:E}).then((()=>e&&n(m(d))))})).then((()=>{f&&a(f)}))}},It=({config:e,targetWindow:t,unmountNodeCallback:r,mountNodeCallback:n,updateAllowedPluginsCallback:o,updateSerializedPropsCollectionCallback:s,updateComponentNodesCollectionCallback:i,updateDebugDataCallback:a,injectStylesAndFilters:l=mt,injectScripts:c=gt,componentNodesFinder:d,errorReporter:h})=>({data:u,boxId:E,slotName:p,slotWrapper:m})=>{const{htmlString:g="",allowedPlugins:b=[],debugData:N,boxEntries:I=[]}=u||{};return o(b),l({targetWindow:t,webResponse:u,config:e,errorReporter:h}).then((()=>(d.findSlotBoxes(E,p).forEach((({node:e})=>{var t;r(e),null===(t=e.parentNode)||void 0===t||t.removeChild(e)})),!!g&&(m.innerHTML=g,!0)))).then((e=>(i(I),c({targetWindow:t,webResponse:u,updateSerializedPropsCollectionCallback:s,errorReporter:h}).then((()=>{e&&d.findSlotBoxes(E,p).forEach((e=>{n(e.node)}))}))))).then((()=>{N&&a(N,E,p)}))};const ft=(e,t="")=>e+t;class Ct{constructor(e,t,r){this.observedElements={},this.downloaded=[],this.registered=[],this.dependencyMapCache=[],this.observer=null,this.observerEntriesHandler=e=>{e.forEach((e=>{var t;if(!e.isIntersecting)return;const r=this.componentNodesFinder.findByNode(e.target);if(!r){const r=this.targetWindow.document.contains(e.target);if(!r)return;const n=null===(t=e.target)||void 0===t?void 0:t.dataset,o=void 0!==this.componentNodesFinder.findByBoxId(null==n?void 0:n.boxId),s=JSON.stringify({prototypeId:null==n?void 0:n.prototypeId,boxName:null==n?void 0:n.boxName,civ:null==n?void 0:n.civ});return void this.reportError(D.COMPONENTS.LAZY_SCRIPTS.MISSING_BOX,{errorContext:{isPartOfDocument:r,data:s,canBeFoundByBoxId:o}})}const{boxEntry:{prototypeId:n,clientImplementationVersion:o}}=r,s=this.getDependencyMapEntry(n,o),i=ft(n,o);this.isDownloaded(i)||(this.markAsDownloaded(i),this.unobserveAllUnderKey(i),s?$e(this.targetWindow,s.scripts):this.reportError(D.COMPONENTS.LAZY_SCRIPTS.MISSING_SCRIPT,{messageData:{prototypeId:n,clientImplementationVersion:o}}))}))},this.onPrototypeRegistered=(e,t)=>{const r=ft(e,t);this.registered.push(r)},this.targetWindow=e,this.reportError=r,this.componentNodesFinder=t}createObserverInstance(){this.observer||(this.observer=new this.targetWindow.IntersectionObserver(this.observerEntriesHandler,{rootMargin:"800px",threshold:0}))}markAsDownloaded(e){this.downloaded.push(e)}isDownloaded(e){return this.downloaded.includes(e)}markAsRegistered(e){this.registered.push(e)}isRegistered(e){return this.registered.includes(e)}observeElement(e,t){this.observedElements[t]=[...this.observedElements[t]||[],e],this.observer.observe(e)}unobserveAllUnderKey(e){this.observedElements[e].forEach((e=>this.observer.unobserve(e)))}getDependencyMapEntry(e,t=""){return this.dependencyMapCache.find((({prototypeId:r,clientImplementationVersion:n=""})=>r===e&&n===t))}observeComponents(e){e.forEach((e=>{const{prototypeId:t,clientImplementationVersion:r}=e,n=this.componentNodesFinder.find(t,r),o=ft(t,r);n.forEach((({node:e})=>{this.observeElement(e,o)}))}))}handleSSRAssets(){const{document:e}=this.targetWindow;R(e,(()=>{this.dependencyMapCache=((e,t)=>{const r=e.querySelector('script[data-config="lazy-scripts-map"]'),n=[];if(!r)return n;try{return JSON.parse(r.textContent||"")}catch(e){return t(D.COMPONENTS.LAZY_SCRIPTS.PARSE_ERR),n}})(e,this.reportError),E(this.dependencyMapCache)||(this.createObserverInstance(),this.observeComponents(this.dependencyMapCache))}))}}function At(e,t){return e.contains(t)}function St(e){return""===e.identity.identityAttributeValue?`[${e.identity.identityAttribute}]`:`[${e.identity.identityAttribute}*="${e.identity.identityAttributeValue}"]`}class Tt{constructor({targetWindow:e,config:t,reportError:r}){this.document=e.document,this.collection=[],this.config=t,this.reportError=r,this.updateNodesCollection(),this.reportNotRenderedBoxes(this.config.boxEntries)}updateNodesCollection(e=[]){e.length&&(e.forEach((e=>{if(!e.slotName||!e.parentBoxId){const t=this.config.boxEntries.find((t=>t.boxId===e.boxId));e.parentBoxId=(null==t?void 0:t.parentBoxId)||null,e.slotName=(null==t?void 0:t.slotName)||null}})),this.config.boxEntries.push(...e));const t=this.config.boxEntries.map((e=>({node:this.document.querySelector(St(e)),boxEntry:e}))).filter((({node:e})=>e)),r=new Set(this.collection.map((({boxEntry:e})=>e))),n=new Set(t.map((({boxEntry:e})=>e)));this.config.boxEntries=this.config.boxEntries.filter((function(e){return!(r.has(e)&&!n.has(e))})),this.collection=t,e.length&&this.reportNotRenderedBoxes(e)}reportNotRenderedBoxes(e){if(!this.reportError)return;const t=new Map;e.forEach((e=>{var r;if(!this.collection.find((t=>t.boxEntry.boxId===e.boxId))){const n=this.findFirstRenderedParent(e.boxId);t.get(null==n?void 0:n.boxName)||t.set(null==n?void 0:n.boxName,[]),null===(r=t.get(null==n?void 0:n.boxName))||void 0===r||r.push({parent:n,slot:e})}})),t.forEach((e=>{const{parent:t}=e[0];if(t){const r=e.filter((({slot:e})=>t.boxId===e.parentBoxId)),n=Array.from(new Set(r.map((({slot:{slotName:e}})=>`"${e}"`))));n.sort(((e,t)=>e.localeCompare(t)));const o=n.join(",");this.reportError(V.SLOTS.KNOWN_BOX_ERR,{messageData:Object.assign({slotList:o},t),errorContext:{notRenderedDirectChildren:JSON.stringify(r.map((({slot:{boxName:e,prototypeId:t}})=>({boxName:e,prototypeId:t})))),tags:{scId:t.scId}}})}else e.forEach((({slot:e})=>{this.reportError(V.SLOTS.UNKNOWN_BOX_ERR,{messageData:Object.assign({},e),errorContext:{trace:JSON.stringify(this.getBoxPath(e.boxId).map((({boxName:e,prototypeId:t})=>({boxName:e,prototypeId:t}))))}})}))}))}getBoxPath(e){const t=this.config.boxEntries.find((t=>(null==t?void 0:t.boxId)===e));if(!(null==t?void 0:t.parentBoxId))return[];const r=this.config.boxEntries.find((e=>e.boxId===(null==t?void 0:t.parentBoxId)));if(!r)return[];const n=this.getBoxPath(r.boxId);return n.unshift(r),n}find(e,t){return t?this.collection.filter((({boxEntry:r})=>r.prototypeId===e&&r.clientImplementationVersion===t)):this.collection.filter((({boxEntry:t})=>t.prototypeId===e))}findFirstRenderedParent(e){const t=this.config.boxEntries.find((t=>(null==t?void 0:t.boxId)===e));if(!(null==t?void 0:t.parentBoxId))return;const r=this.config.boxEntries.find((e=>e.boxId===(null==t?void 0:t.parentBoxId)));return r?this.collection.find((e=>e.boxEntry.boxId===r.boxId))?r:this.findFirstRenderedParent(r.boxId):void 0}findClosestAncestor(e){var t;const r=this.collection.filter((({node:t})=>At(t,e))),n=r.filter((({node:e})=>!r.filter((t=>t.node!==e)).some((t=>At(e,t.node)))))[0];if(n)return n;let o=e.closest(`[${ie}]`);return o||(o=e.closest(`[${ae}]`)),o?{boxEntry:{boxId:o.getAttribute("data-box-id")||"",boxName:o.getAttribute(ie)||"",analytics:{category:o.getAttribute(ae)||"",groups:JSON.parse(decodeURIComponent(o.getAttribute("data-analytics-groups")||"")||"[]"),tags:(null===(t=o.getAttribute(le))||void 0===t?void 0:t.split(","))||[]}},node:o}:null}findByBoxId(e,t=!1){return this.collection.find((r=>t?r.boxEntry.placeholderFor===e:r.boxEntry.boxId===e))}findSlotBoxes(e,t){return this.collection.filter((r=>r.boxEntry.parentBoxId===e&&r.boxEntry.slotName===t))}findByNode(e){return this.collection.find((t=>t.node===e))}findBySlug(e){return this.collection.find((t=>t.boxEntry.slug===e))}findSubtree(e){return this.collection.filter((t=>At(e,t.node)))}getBlameTags(e){var t,r;try{const n=this.findClosestAncestor(e);return(null===(t=null==n?void 0:n.boxEntry)||void 0===t?void 0:t.scId)?{tags:{scId:null===(r=null==n?void 0:n.boxEntry)||void 0===r?void 0:r.scId}}:{tags:{}}}catch(e){return{tags:{}}}}findAllPlaceholders(){return this.collection.filter((e=>e.boxEntry.placeholderFor))}}class vt{constructor(){this.listeners=new Map}addEventListener(e,t){const r=this.listeners.get(e)||new Set;r.add(t),this.listeners.set(e,r)}removeEventListener(e,t){const r=this.listeners.get(e);r&&(r.delete(t),this.listeners.set(e,r))}trigger(e){const t=this.listeners.get(e.type);t&&t.forEach((t=>t(e)))}}const Ot=(e,t,r)=>e.map((e=>Object.assign(Object.assign({},e),{updatedAt:r,rawParameters:t.resolveAll(e.rawParameters),slots:e.slots.map((e=>Object.assign(Object.assign({},e),{boxes:Ot(e.boxes,t,r)})))}))),yt=(e,t,r)=>e.map((e=>{const n=t.get(e.boxId)||t.get(e.name);return Object.assign(Object.assign({},e),{updatedAt:n?r:e.updatedAt,rawParameters:n||e.rawParameters,slots:e.slots.map((e=>Object.assign(Object.assign({},e),{boxes:yt(e.boxes,t,r)})))})})),Pt=(e,t,r)=>{for(const n of e){if(t(n))return{parentSlot:r,box:n};if(n.slots)for(const e of n.slots){const r=Pt(e.boxes,t,e);if(r)return r}}};class Rt{constructor({targetWindow:e,reportError:t,componentNodesFinder:r}){this.initialize=()=>{const e=this.window.document.getElementById("page-debug-data");if(!e)return void this.disableCallbackQueueing();let t;try{t=JSON.parse(e.textContent)}catch(e){return this.disableCallbackQueueing(),void this.reportError(D.DEBUG_DATA.PARSE_ERR)}this.updateData(t),this.initialized=!0,this.eventBus.trigger(new CustomEvent("init",{detail:this.getData()}));for(const e of this.queuedStructureChanges)e(),this.triggerUpdateEvent();this.clearQueuedCallbacks()},this.updateData=(e,t,r)=>{if(!e)return;const n=this.debugData;this.debugData=Object.assign(Object.assign({},n),e);const o=e.pageDefinition.dataSources.reduce(((e,t)=>Object.assign(Object.assign({},e),{[t.name]:t})),{}),s=new w(o);if(e.boxes.length>0){const n=Date.now(),o=Ot(e.boxes,s,n);t?this.boxes=r?((e,t,r,n)=>{const o=Pt(e,(e=>e.boxId===t));if(null==o?void 0:o.box){const e=o.box.slots.find((e=>e.name===r));e&&(e.boxes=n)}return e})(this.boxes,t,r,o):((e,t,r)=>{const n=e=>e.placeholderFor===t,o=Pt(e,n);if(null==o?void 0:o.parentSlot)o.parentSlot.boxes=o.parentSlot.boxes.flatMap((e=>e===o.box?r:e));else if(null==o?void 0:o.box)return e.flatMap((e=>n(e)?r:e));return e})(this.boxes,t,o):this.boxes.push(...o)}if(e.plugins.length>0){const t=((e,t)=>e.map((e=>Object.assign(Object.assign({},e),{parameters:t.resolveAll(e.parameters)}))))(e.plugins,s);for(const e of t){const t=this.plugins.get(e.name);t?this.plugins.set(e.name,Object.assign(Object.assign({},t),{parameters:e.parameters})):this.plugins.set(e.name,e)}}for(const t of e.services)this.services.has(t.name)||this.services.set(t.name,t);this.debugData.pageDefinition.failedBoxesCount+=(null==n?void 0:n.pageDefinition.failedBoxesCount)||0;const i=e=>{this.debugData.pageDefinition[e]=[...(null==n?void 0:n.pageDefinition[e])||[],...this.debugData.pageDefinition[e]||[]]};i("failedBoxes"),i("failedPlugins"),i("failedDataSources")},this.onSubtree=(e,t,r)=>{this.execOrQueueStructureChange((()=>{this.updateData(e,t,r)}))},this.onRawDataChange=e=>{this.execOrQueueStructureChange((()=>{this.boxes=yt(this.boxes,new Map(Object.entries(e.resolvedBoxes)),Date.now())}))},this.execOrQueueStructureChange=e=>{this.initialized?(e(),this.triggerUpdateEvent()):this.allowCallbackQueue&&this.queuedStructureChanges.push(e)},this.getData=()=>this.initialized&&this.debugData?Object.assign(Object.assign({},this.debugData),{boxes:this.boxes,plugins:Array.from(this.plugins.values()),services:Array.from(this.services.values())}):null,this.addEventListener=(e,t)=>{this.eventBus.addEventListener(e,t)},this.removeEventListener=(e,t)=>{this.eventBus.removeEventListener(e,t)},this.disableCallbackQueueing=()=>{this.allowCallbackQueue=!1,this.clearQueuedCallbacks()},this.clearQueuedCallbacks=()=>{this.queuedStructureChanges=[]},this.triggerUpdateEvent=()=>{this.eventBus.trigger(new CustomEvent("update",{detail:this.getData()}))},this.createAPI=()=>({get:this.getData,addListener:this.addEventListener,removeListener:this.removeEventListener,findClosestAncestor:this.componentNodesFinder.findClosestAncestor.bind(this.componentNodesFinder)}),this.window=e,this.initialized=!1,this.reportError=t,this.eventBus=new vt,this.boxes=[],this.plugins=new Map,this.services=new Map,this.allowCallbackQueue=!0,this.queuedStructureChanges=[],this.componentNodesFinder=r,R(this.window.document,(()=>{!function(e,t){e.requestAnimationFrame((()=>{P(t)}))}(this.window,(()=>this.initialize()))}))}}const xt="";function wt(e){return u(e)&&!("clientImplementationVersion"in e)?Object.assign(e,{clientImplementationVersion:xt}):e}function _t({instance:e,method:t,reportError:r,data:n=null,onSuccess:o=()=>{},blameTags:s}){if(e&&"function"==typeof e[t])try{e[t](n),o()}catch(e){r(V.REGISTRY.LIFECYCLE_ERR,{error:e,messageData:{method:t},errorContext:s})}}function Lt(e,t){return t===xt?e:`${e}@${t}`}const Mt="data-serialize-box-id",Dt="data-serialize-box-name",kt=`script[${Mt}], script[${Dt}]`;class Vt{constructor(e,t){this.collection=[],this.targetWindow=e,this.reportError=t,this.updateNodesCollection()}updateNodesCollection(){this.collection=Array.from(this.targetWindow.document.querySelectorAll(kt))}getNodeByBoxId(e){return this.collection.find((t=>t.getAttribute(Mt)===e))}getNodeByBoxName(e){return this.collection.find((t=>t.getAttribute(Dt)===e))}getPropsFromNode(e,t,r){if(!e)return{};try{return JSON.parse(e.textContent||"")}catch(e){return this.reportError(D.COMPONENTS.SERIALIZED_PROPS.PARSE_ERR,{error:e,messageData:{boxName:r,boxId:t}}),{}}}getPropsForBox(e,t){const r=this.getNodeByBoxId(e)||this.getNodeByBoxName(t);return r?this.getPropsFromNode(r,e,t):{}}}class Gt{constructor({targetWindow:e,services:t,reportError:r,unmountNodeCallback:n,mountNodeCallback:o,componentNodesFinder:s,registerPrototypeCallback:i}){this.unmountNode=e=>{this.unmountNodeCallback(e),this.componentNodesFinder.findSubtree(e).forEach((({boxEntry:e})=>{const t=e.boxId||e.boxName;_t({instance:this.instances.get(t),method:"onUnmount",reportError:this.reportError,blameTags:this.getBlameTagsForMountedInstance(t)}),this.instances.set(t,null),this.blameTags.set(t,null)}))},this.mountNode=e=>{this.componentNodesFinder.findSubtree(e).forEach((({boxEntry:e,node:t})=>{const r=e.prototypeId,n=e.clientImplementationVersion||xt;this.registerInstancesForPrototype(r,n,[{boxEntry:e,node:t}])})),this.mountNodeCallback(e)},this.updateComponentCallback=(e,t)=>{const r=this.instances.get(e);r?P((()=>{_t({instance:r,method:"onUpdate",reportError:this.reportError,data:t,blameTags:this.getBlameTagsForMountedInstance(e)})})):this.boxDataCache.set(e,t)},this.beforeUpdateComponentCallback=()=>{this.instances.forEach(((e,t)=>_t({instance:e,method:"beforeOnUpdate",reportError:this.reportError,blameTags:this.getBlameTagsForMountedInstance(t)})))},this.register=(e,t)=>{const r=function(e){return Array.isArray(e)?e.map(wt):wt(e)}(e);this.isPrototypeValid(r)&&this.isImplementationValid(t)&&(Array.isArray(r)?r.forEach((e=>{this.registerImplementationAndInstances(e,t)})):this.registerImplementationAndInstances(r,t))},this.updateSerializedPropsCollection=()=>{this.serializedPropsFinder.updateNodesCollection()},this.updateComponentNodesCollection=e=>{this.componentNodesFinder.updateNodesCollection(e)},this.services=t,this.implementations=new Map,this.instances=new Map,this.blameTags=new Map,this.boxDataCache=new Map,this.reportError=r,this.unmountNodeCallback=n,this.mountNodeCallback=o,this.registerPrototypeCallback=i,this.serializedPropsFinder=new Vt(e,r),this.componentNodesFinder=s}isPrototypeObjectValid(e){const{prototypeName:t,clientImplementationVersion:r}=e;return"prototypeName"in e?""===t?(this.reportError(G.COMPONENT.REGISTER.EMPTY_PROTOTYPE_NAME),!1):"string"!=typeof t?(this.reportError(G.COMPONENT.REGISTER.INVALID_PROTOTYPE_NAME,{messageData:{type:typeof t}}),!1):"string"!=typeof r?(this.reportError(G.COMPONENT.REGISTER.INVALID_IMPLEMENTATION_VERSION,{messageData:{type:typeof r}}),!1):(""===r&&this.reportError(G.COMPONENT.REGISTER.MISSING_IMPLEMENTATION_VERSION),!0):(this.reportError(G.COMPONENT.REGISTER.MISSING_PROTOTYPE_NAME),!1)}containsValidPrototypes(e){return 0===e.length?(this.reportError(G.COMPONENT.REGISTER.MISSING_HANDLED_PROTOTYPES),!1):!e.filter((e=>!this.isPrototypeObjectValid(e))).length}isPrototypeValid(e){return Array.isArray(e)?this.containsValidPrototypes(e):u(e)?this.isPrototypeObjectValid(e):(this.reportError(G.COMPONENT.REGISTER.INVALID_HANDLED_PROTOTYPE),!1)}isImplementationValid(e){return"function"!=typeof e?(this.reportError(G.COMPONENT.REGISTER.INVALID_IMPLEMENTATION),!1):e.prototype.onUpdate&&"function"!=typeof e.prototype.onUpdate?(this.reportError(G.COMPONENT.REGISTER.INVALID_ONUPDATE,{messageData:{type:typeof e.prototype.onUpdate}}),!1):"function"==typeof e.prototype.onMount||(this.reportError(G.COMPONENT.REGISTER.MISSING_ONMOUNT),!1)}registerInstancesForPrototype(e,t,r){const n=this.implementations.get(Lt(e,t));n&&(this.registerInstances(r,this.services.getServicesForComponent(),n),this.registerPrototypeCallback(e,t))}registerImplementationAndInstances({prototypeName:e,clientImplementationVersion:t},r){const n=Lt(e,t),o=t===xt;this.implementations.has(n)?this.reportError(G.COMPONENT.REGISTER.ALREADY_REGISTERED,{messageData:{prototypeName:e,implementationVersionMessage:o?"":`with ${t} client implementation version`}}):(this.implementations.set(n,r),this.registerInstancesForPrototype(e,t,this.componentNodesFinder.find(e,t)))}static createBlameTags(e){return e?{tags:{scId:e}}:{tags:{}}}getBlameTagsForMountedInstance(e){return this.blameTags.get(e)||Gt.createBlameTags(null)}registerInstances(e,t,r){e.forEach((({node:e,boxEntry:n})=>{if(null==e?void 0:e.getAttribute(h))return;const{boxId:o,boxName:s,scId:i}=n,a=o||s;P((()=>{if(this.instances.get(a))return;const n=this.serializedPropsFinder.getPropsForBox(o,s),l=new r({baseNode:e,props:n,services:t,boxEntry:{boxId:o}}),c=Gt.createBlameTags(i);_t({instance:l,method:"onMount",reportError:this.reportError,blameTags:c,onSuccess:()=>{this.instances.set(a,l),this.blameTags.set(a,c)}}),this.boxDataCache.has(a)&&(_t({instance:l,method:"beforeOnUpdate",reportError:this.reportError,blameTags:c}),this.updateComponentCallback(a,this.boxDataCache.get(a)),this.boxDataCache.delete(a))}))}))}createAPI(){return{register:this.register}}}const Bt=new class{constructor(e,t,r){this.lazyloadedElement=({target:e})=>{this.componentNodesFinder.findByNode(e)||this.componentNodesFinder.updateNodesCollection();const t=this.componentNodesFinder.findByNode(e);if(t&&t.boxEntry.placeholderFor){const e={boxId:t.boxEntry.placeholderFor,isPlaceholder:!0};this.opboxWebClient.render.box(e)}},this.attach=()=>{const e=a(this.targetWindow),t=this.API;var r,n,o;e&&(Ke(e,t,((t,...r)=>((e,t)=>{e[i]=e[i]||{},Object.keys(t).forEach((r=>{e[i][r]=t[r]}))})(this.targetWindow,f(e,t,...r)))),r=e,o=t,n=Object.keys(o).concat("initialized","config"),A(r,(e=>!n.includes(e))),Object.freeze(e)),this.broadcastAPILoadEvent(),this.targetWindow.addEventListener("lazyloaded",this.lazyloadedElement),this.updateInlinePreference(),t.performance.markTimeToInteractive("sc-12453")},this.targetWindow=e,this.document=e.document;const n=(e=>a(e).config)(e),o=new Re({targetWindow:e,config:n}),s=(e=>(t,r={})=>{if(0===t.status)return;const{tags:n}=r,o=Ae(r,["tags"]);e.opbox.plugin.get("sentry").then((r=>r.captureException(t,Object.assign({contexts:nt(e,o)},!E(n)&&{tags:n})))).catch(b)})(e),l=((e,t,r)=>(n,{error:o,messageData:s={},errorContext:i={}}={})=>{const a=o,l=[n,H[n](s),null==a?void 0:a.message].filter(Boolean).join(" "),c=new Error(l);(null==a?void 0:a.stack)&&(c.stack=a.stack),(null==r?void 0:r.opboxWebBrowserDocs)&&(e.console.group(`${r.opboxWebBrowserDocs}/tagged-errors/#${n}`),e.console.error(c),e.console.log("contextData",i),e.console.groupEnd()),t(c,i)})(e,s,n.links),c=new Tt({targetWindow:e,config:n,reportError:l}),d=new _e({targetWindow:e,componentNodesFinder:c}),h=new Ce({targetWindow:e,config:n,cookieMonsterClient:o,boxViewsMarker:d,reportError:l,componentNodesFinder:c}),u=new qe({targetWindow:e,reportError:l}),p=new Ct(e,c,l),m=new Gt({targetWindow:e,services:u,reportError:l,componentNodesFinder:c,registerPrototypeCallback:p.onPrototypeRegistered,unmountNodeCallback:d.unmountNode,mountNodeCallback:d.markBoxAsRendered}),g=new Xe({reportError:l,allowedPlugins:n.allowedPlugins}),N=new Rt({targetWindow:e,reportError:l,componentNodesFinder:c}),I={config:n,targetWindow:e,unmountNodeCallback:m.unmountNode,mountNodeCallback:m.mountNode,updateSerializedPropsCollectionCallback:m.updateSerializedPropsCollection,updateComponentNodesCollectionCallback:m.updateComponentNodesCollection,updateAllowedPluginsCallback:g.boundUpdateRegistry,updateDebugDataCallback:N.onSubtree,setFragmentAnalyticsContext:h.setFragmentAnalyticsContext,deleteFragmentAnalyticsContext:h.deleteFragmentAnalyticsContext,componentNodesFinder:c,errorReporter:s},C=new q({config:n,targetWindow:e,httpClient:t,reportError:l,boxRenderCallback:bt(I),fragmentRenderCallback:Nt(I),slotRenderCallback:It(I),componentNodesFinder:c});this.config=n,this.cookieMonsterClient=o,this.boxViewsMarker=d,this.analytics=h,this.services=u,this.components=m,this.opboxWebClient=C,this.plugins=g,this.reportError=s,this.lazyScriptsManager=p,this.debugData=N,this.componentNodesFinder=c,this.navigation=new ke({targetWindow:e,opboxWebClient:C,analytics:h,debugData:N,updateViewIdCallback:C.updateViewId,updateComponentCallback:m.updateComponentCallback,beforeUpdateComponentCallback:m.beforeUpdateComponentCallback,reportError:l}),this.edgeClient=new Oe({httpClient:r,edgeHost:n.edgeHost,config:n}),this.edgeUploadClient=new Oe({httpClient:r,edgeHost:n.edgeUploadHost,config:n}),this.preferencesClient=new rt({edgeClient:this.edgeClient,reportError:l}),this.uiTools=We(e,c),p.handleSSRAssets(),h.initialize(),this.navigation.initialize(),d.initialize()}get API(){return{analytics:this.analytics.createAPI(),boxViewsMarker:this.boxViewsMarker.createAPI(),component:this.components.createAPI(),plugin:this.plugins.createAPI(),changeParams:this.navigation.navigateRelative,refreshPage:this.navigation.refreshPage,tween:this.uiTools.tween,scrollTo:this.uiTools.scrollTo,page:this.opboxWebClient.createAPI(),navigation:this.navigation.createAPI(),edge:this.edgeClient.createAPI(),edgeUpload:this.edgeUploadClient.createAPI(),preferences:this.preferencesClient.createAPI(),loaded:!0,performance:a(this.targetWindow).performance,services:this.services.createAPI(),reportError:this.reportError,__internal__debug:this.debugData.createAPI()}}renderBoxForLazyloadedPlaceholders(){this.componentNodesFinder.findAllPlaceholders().filter((({node:e})=>e.classList.contains("lazyloaded"))).forEach((({boxEntry:e})=>{const t={boxId:e.placeholderFor,isPlaceholder:!0};this.opboxWebClient.render.box(t)}))}updateInlinePreference(){const{config:e,preferencesClient:t}=this;e.cssBundle&&e.cssBundle.shouldInline&&t.setPreference("receivedInline",!0)}broadcastAPILoadEvent(){I(this.targetWindow,"opboxAPILoaded")}run(){this.attach(),this.uiTools.scrollToLocationHash(),this.renderBoxForLazyloadedPlaceholders()}}(window,s(),s());setTimeout((()=>{Bt.run()}),0);const{attach:Ft}=Bt;return e.attach=Ft,e}({});
//# sourceMappingURL=opbox-BXKGWjQw.js.map
